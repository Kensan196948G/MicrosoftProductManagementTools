#Requires -Version 5.1

<#
.SYNOPSIS
Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ†ã‚¹ãƒˆ

.DESCRIPTION
ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹å†…ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã€è¨­å®šãƒŸã‚¹ã€æ©Ÿå¯†æƒ…å ±æ¼æ´©ã‚’æ¤œæŸ»ã—ã¾ã™ã€‚
ITSMæº–æ‹ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«åŸºã¥ãåŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

.NOTES
Version: 2025.7.17.1
Author: Test/QA Developer
Requires: PowerShell 5.1+
Security: é˜²å¾¡çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ï¼ˆåˆ†æå°‚ç”¨ï¼‰

.EXAMPLE
.\security-vulnerability-test.ps1
åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ

.EXAMPLE
.\security-vulnerability-test.ps1 -Detailed -GenerateReport
è©³ç´°ã‚¹ã‚­ãƒ£ãƒ³ã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’å®Ÿè¡Œ

.EXAMPLE
.\security-vulnerability-test.ps1 -ScanType "ConfigSecurity"
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ã¿ã‚’ã‚¹ã‚­ãƒ£ãƒ³
#>

[CmdletBinding()]
param(
    [ValidateSet("All", "CodeSecurity", "ConfigSecurity", "CredentialScan", "PermissionCheck", "CertificateValidation")]
    [string]$ScanType = "All",
    
    [switch]$Detailed,
    [switch]$GenerateReport = $true,
    [string]$OutputPath = "TestReports"
)

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³è¨­å®š
$script:SecurityFindings = @()
$script:CriticalFindings = 0
$script:HighFindings = 0
$script:MediumFindings = 0
$script:LowFindings = 0
$script:ScanStartTime = Get-Date

# 1. èªè¨¼æƒ…å ±ã®éœ²å‡ºãƒã‚§ãƒƒã‚¯
Write-Host "1. èªè¨¼æƒ…å ±ã®éœ²å‡ºãƒã‚§ãƒƒã‚¯" -ForegroundColor Yellow
Write-Host "   - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã‚’æ¤œç´¢ä¸­..." -ForegroundColor Gray

try {
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èªè¨¼æƒ…å ±ãƒã‚§ãƒƒã‚¯
    $configPath = Join-Path $PSScriptRoot "..\Config\appsettings.json"
    if (Test-Path $configPath) {
        $config = Get-Content $configPath -Raw | ConvertFrom-Json
        
        # å±é™ºãªå€¤ã®æ¤œå‡º
        $dangerousValues = @(
            "YOUR-CERTIFICATE-THUMBPRINT-HERE",
            "YOUR-CERTIFICATE-PASSWORD-HERE",
            "YOUR-USERNAME-HERE",
            "YOUR-PASSWORD-HERE",
            "YOUR-CLIENT-SECRET-HERE"
        )
        
        $configText = Get-Content $configPath -Raw
        foreach ($dangerousValue in $dangerousValues) {
            if ($configText -like "*$dangerousValue*") {
                $SecurityFindings += [PSCustomObject]@{
                    Category = "èªè¨¼æƒ…å ±"
                    Severity = "Low"
                    Issue = "ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤ãŒæ®‹å­˜"
                    File = $configPath
                    Description = "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã« '$dangerousValue' ãŒæ®‹ã£ã¦ã„ã¾ã™"
                    Recommendation = "å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã‚‹ã‹ã€ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
                }
            }
        }
        
        # ç’°å¢ƒå¤‰æ•°ã®é©åˆ‡ãªä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯
        $environmentVariables = @("REACT_APP_MS_TENANT_ID", "REACT_APP_MS_CLIENT_ID", "MS_CLIENT_SECRET", "EXO_CERTIFICATE_PASSWORD")
        $usesEnvironmentVariables = 0
        foreach ($envVar in $environmentVariables) {
            if ($configText -like "*`$`{$envVar`}*") {
                $usesEnvironmentVariables++
            }
        }
        
        if ($usesEnvironmentVariables -gt 0) {
            Write-Host "   âœ… ç’°å¢ƒå¤‰æ•°ã®ä½¿ç”¨ã‚’ç¢ºèª ($usesEnvironmentVariables/$($environmentVariables.Count) é …ç›®)" -ForegroundColor Green
        } else {
            $SecurityFindings += [PSCustomObject]@{
                Category = "èªè¨¼æƒ…å ±"
                Severity = "High"
                Issue = "ç’°å¢ƒå¤‰æ•°ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„"
                File = $configPath
                Description = "æ©Ÿå¯†æƒ…å ±ãŒå¹³æ–‡ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§"
                Recommendation = "ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦æ©Ÿå¯†æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„"
            }
        }
    }
} catch {
    $SecurityFindings += [PSCustomObject]@{
        Category = "èªè¨¼æƒ…å ±"
        Severity = "Medium"
        Issue = "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å¤±æ•—"
        File = $configPath
        Description = $_.Exception.Message
        Recommendation = "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã¨æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    }
}

# 2. PowerShell ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒãƒã‚§ãƒƒã‚¯
Write-Host "2. PowerShell ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒãƒã‚§ãƒƒã‚¯" -ForegroundColor Yellow
Write-Host "   - ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å…¥åŠ›æ¤œè¨¼ã‚’ç¢ºèªä¸­..." -ForegroundColor Gray

$scriptFiles = Get-ChildItem -Path "$PSScriptRoot\.." -Filter "*.ps1" -Recurse
$dangerousPatterns = @(
    "Invoke-Expression",
    "IEX",
    "& \$",
    "cmd /c",
    "powershell.exe",
    "Start-Process.*cmd"
)

foreach ($scriptFile in $scriptFiles) {
    try {
        $content = Get-Content $scriptFile.FullName -Raw
        foreach ($pattern in $dangerousPatterns) {
            if ($content -match $pattern) {
                $SecurityFindings += [PSCustomObject]@{
                    Category = "ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒ"
                    Severity = "High"
                    Issue = "å±é™ºãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³"
                    File = $scriptFile.FullName
                    Description = "ãƒ‘ã‚¿ãƒ¼ãƒ³ '$pattern' ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
                    Recommendation = "å…¥åŠ›æ¤œè¨¼ã‚’è¿½åŠ ã—ã€å®‰å…¨ãªå®Ÿè¡Œæ–¹æ³•ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
                }
            }
        }
    } catch {
        # ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
    }
}

# 3. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æ©Ÿå¯†æƒ…å ±éœ²å‡ºãƒã‚§ãƒƒã‚¯
Write-Host "3. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æ©Ÿå¯†æƒ…å ±éœ²å‡ºãƒã‚§ãƒƒã‚¯" -ForegroundColor Yellow
Write-Host "   - ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æ©Ÿå¯†æƒ…å ±ã‚’ç¢ºèªä¸­..." -ForegroundColor Gray

$logDirectory = Join-Path $PSScriptRoot "..\Logs"
if (Test-Path $logDirectory) {
    $logFiles = Get-ChildItem -Path $logDirectory -Filter "*.log" -Recurse
    $sensitivePatterns = @(
        "password",
        "secret",
        "token",
        "key",
        "credential",
        "cert.*password"
    )
    
    foreach ($logFile in $logFiles) {
        try {
            $content = Get-Content $logFile.FullName -Raw
            foreach ($pattern in $sensitivePatterns) {
                if ($content -match $pattern) {
                    $SecurityFindings += [PSCustomObject]@{
                        Category = "ãƒ­ã‚°æ©Ÿå¯†æƒ…å ±"
                        Severity = "Medium"
                        Issue = "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§"
                        File = $logFile.FullName
                        Description = "ãƒ‘ã‚¿ãƒ¼ãƒ³ '$pattern' ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
                        Recommendation = "ãƒ­ã‚°å‡ºåŠ›æ™‚ã«æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚¹ã‚¯ã—ã¦ãã ã•ã„"
                    }
                }
            }
        } catch {
            # ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
    }
}

# 4. ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯
Write-Host "4. ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯" -ForegroundColor Yellow
Write-Host "   - é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’ç¢ºèªä¸­..." -ForegroundColor Gray

$criticalFiles = @(
    (Join-Path $PSScriptRoot "..\Config\appsettings.json"),
    (Join-Path $PSScriptRoot "..\Certificates\*.pfx")
)

foreach ($filePath in $criticalFiles) {
    if ($filePath -like "*\*") {
        # ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆ
        $files = Get-ChildItem -Path $filePath -ErrorAction SilentlyContinue
        foreach ($file in $files) {
            try {
                $acl = Get-Acl $file.FullName
                $everyoneAccess = $acl.Access | Where-Object { $_.IdentityReference -eq "Everyone" }
                if ($everyoneAccess) {
                    $SecurityFindings += [PSCustomObject]@{
                        Category = "ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™"
                        Severity = "High"
                        Issue = "é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã« Everyone ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™"
                        File = $file.FullName
                        Description = "èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªçŠ¶æ…‹ã§ã™"
                        Recommendation = "ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’åˆ¶é™ã—ã¦ãã ã•ã„"
                    }
                }
            } catch {
                # æ¨©é™ç¢ºèªã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        }
    } else {
        # å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
        if (Test-Path $filePath) {
            try {
                $acl = Get-Acl $filePath
                $everyoneAccess = $acl.Access | Where-Object { $_.IdentityReference -eq "Everyone" }
                if ($everyoneAccess) {
                    $SecurityFindings += [PSCustomObject]@{
                        Category = "ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™"
                        Severity = "High"
                        Issue = "é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã« Everyone ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™"
                        File = $filePath
                        Description = "èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªçŠ¶æ…‹ã§ã™"
                        Recommendation = "ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’åˆ¶é™ã—ã¦ãã ã•ã„"
                    }
                }
            } catch {
                # æ¨©é™ç¢ºèªã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        }
    }
}

# 5. è¨¼æ˜æ›¸ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
Write-Host "5. è¨¼æ˜æ›¸ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯" -ForegroundColor Yellow
Write-Host "   - è¨¼æ˜æ›¸ã®æœ‰åŠ¹æ€§ã¨è¨­å®šã‚’ç¢ºèªä¸­..." -ForegroundColor Gray

try {
    $certDirectory = Join-Path $PSScriptRoot "..\Certificates"
    if (Test-Path $certDirectory) {
        $certFiles = Get-ChildItem -Path $certDirectory -Filter "*.pfx"
        foreach ($certFile in $certFiles) {
            try {
                # è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
                $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2
                $cert.Import($certFile.FullName)
                
                $daysToExpiry = ($cert.NotAfter - (Get-Date)).Days
                if ($daysToExpiry -lt 30) {
                    $SecurityFindings += [PSCustomObject]@{
                        Category = "è¨¼æ˜æ›¸"
                        Severity = "High"
                        Issue = "è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ãŒè¿‘ã„"
                        File = $certFile.FullName
                        Description = "è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ã¾ã§ $daysToExpiry æ—¥ã§ã™"
                        Recommendation = "è¨¼æ˜æ›¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„"
                    }
                }
            } catch {
                # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã•ã‚ŒãŸè¨¼æ˜æ›¸ã®å ´åˆã¯æœŸé™ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
            }
        }
    }
} catch {
    # è¨¼æ˜æ›¸ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
}

# 6. Microsoft Graph API ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯
Write-Host "6. Microsoft Graph API ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒã‚§ãƒƒã‚¯" -ForegroundColor Yellow
Write-Host "   - APIã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®å¦¥å½“æ€§ã‚’ç¢ºèªä¸­..." -ForegroundColor Gray

try {
    $configPath = Join-Path $PSScriptRoot "..\Config\appsettings.json"
    if (Test-Path $configPath) {
        $config = Get-Content $configPath -Raw | ConvertFrom-Json
        $scopes = $config.EntraID.Scopes
        
        # éå‰°æ¨©é™ã®ãƒã‚§ãƒƒã‚¯
        $highRiskScopes = @(
            "https://graph.microsoft.com/Directory.ReadWrite.All",
            "https://graph.microsoft.com/User.ReadWrite.All",
            "https://graph.microsoft.com/Group.ReadWrite.All",
            "https://graph.microsoft.com/Files.ReadWrite.All"
        )
        
        foreach ($scope in $scopes) {
            if ($scope -in $highRiskScopes) {
                $SecurityFindings += [PSCustomObject]@{
                    Category = "APIæ¨©é™"
                    Severity = "Medium"
                    Issue = "éå‰°ãªAPIæ¨©é™"
                    File = $configPath
                    Description = "é«˜ãƒªã‚¹ã‚¯ã‚¹ã‚³ãƒ¼ãƒ—: $scope"
                    Recommendation = "å¿…è¦æœ€å°é™ã®æ¨©é™ã«åˆ¶é™ã—ã¦ãã ã•ã„"
                }
            }
        }
    }
} catch {
    # APIæ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
}

# 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ç¢ºèª
Write-Host "7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ç¢ºèª" -ForegroundColor Yellow
Write-Host "   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’ç¢ºèªä¸­..." -ForegroundColor Gray

try {
    $configPath = Join-Path $PSScriptRoot "..\Config\appsettings.json"
    if (Test-Path $configPath) {
        $config = Get-Content $configPath -Raw | ConvertFrom-Json
        $security = $config.Security
        
        # é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ç¢ºèª
        $securityChecks = @(
            @{ Setting = "EncryptSensitiveData"; Expected = $true; Severity = "High" },
            @{ Setting = "RequireMFAForAdmins"; Expected = $true; Severity = "High" },
            @{ Setting = "EnableAuditTrail"; Expected = $true; Severity = "Medium" }
        )
        
        foreach ($check in $securityChecks) {
            if ($security.($check.Setting) -ne $check.Expected) {
                $SecurityFindings += [PSCustomObject]@{
                    Category = "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š"
                    Severity = $check.Severity
                    Issue = "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãŒæ¨å¥¨å€¤ã¨ç•°ãªã‚‹"
                    File = $configPath
                    Description = "$($check.Setting) = $($security.($check.Setting)), æ¨å¥¨å€¤: $($check.Expected)"
                    Recommendation = "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’æ¨å¥¨å€¤ã«å¤‰æ›´ã—ã¦ãã ã•ã„"
                }
            }
        }
    }
} catch {
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
}

# çµæœã®è¡¨ç¤º
Write-Host ""
Write-Host "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨ºæ–­çµæœ ===" -ForegroundColor Cyan

if ($SecurityFindings.Count -eq 0) {
    Write-Host "âœ… é‡å¤§ãªè„†å¼±æ€§ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" -ForegroundColor Green
} else {
    Write-Host "âš ï¸  $($SecurityFindings.Count) ä»¶ã®å•é¡ŒãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ" -ForegroundColor Yellow
    Write-Host ""
    
    # æ·±åˆ»åº¦åˆ¥ã®é›†è¨ˆ
    $criticalCount = ($SecurityFindings | Where-Object { $_.Severity -eq "Critical" }).Count
    $highCount = ($SecurityFindings | Where-Object { $_.Severity -eq "High" }).Count
    $mediumCount = ($SecurityFindings | Where-Object { $_.Severity -eq "Medium" }).Count
    $lowCount = ($SecurityFindings | Where-Object { $_.Severity -eq "Low" }).Count
    
    Write-Host "æ·±åˆ»åº¦åˆ¥é›†è¨ˆ:" -ForegroundColor White
    if ($criticalCount -gt 0) { Write-Host "  Critical: $criticalCount" -ForegroundColor Red }
    if ($highCount -gt 0) { Write-Host "  High: $highCount" -ForegroundColor Magenta }
    if ($mediumCount -gt 0) { Write-Host "  Medium: $mediumCount" -ForegroundColor Yellow }
    if ($lowCount -gt 0) { Write-Host "  Low: $lowCount" -ForegroundColor Cyan }
    
    Write-Host ""
    Write-Host "è©³ç´°:" -ForegroundColor White
    
    foreach ($finding in $SecurityFindings) {
        $color = switch ($finding.Severity) {
            "Critical" { "Red" }
            "High" { "Magenta" }
            "Medium" { "Yellow" }
            "Low" { "Cyan" }
            default { "White" }
        }
        
        Write-Host "[$($finding.Severity)] $($finding.Category): $($finding.Issue)" -ForegroundColor $color
        Write-Host "  ãƒ•ã‚¡ã‚¤ãƒ«: $($finding.File)" -ForegroundColor Gray
        Write-Host "  è©³ç´°: $($finding.Description)" -ForegroundColor Gray
        Write-Host "  æ¨å¥¨å¯¾å¿œ: $($finding.Recommendation)" -ForegroundColor Gray
        Write-Host ""
    }
}

# CSVå½¢å¼ã§ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
try {
    $reportPath = Join-Path $PSScriptRoot "TestReports\security-vulnerability-report_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
    
    # TestReportsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    $reportDir = Split-Path $reportPath
    if (-not (Test-Path $reportDir)) {
        New-Item -ItemType Directory -Path $reportDir -Force | Out-Null
    }
    
    $SecurityFindings | Export-Csv -Path $reportPath -NoTypeInformation -Encoding UTF8
    Write-Host "ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¾ã—ãŸ: $reportPath" -ForegroundColor Green
} catch {
    Write-Host "âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)" -ForegroundColor Yellow
}

Write-Host ""
Write-Host "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ†ã‚¹ãƒˆå®Œäº†" -ForegroundColor Green