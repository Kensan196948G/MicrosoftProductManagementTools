#Requires -Version 5.1

<#
.SYNOPSIS
Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« - æ‹¡å¼µã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ†ã‚¹ãƒˆ

.DESCRIPTION
Dev2 - Test/QA Developerã«ã‚ˆã‚‹åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ†ã‚¹ãƒˆã€‚
ISO/IEC 27001æº–æ‹ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã€OWASP Top 10ã€é˜²å¾¡çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè£…ã€‚

.NOTES
Version: 2025.7.18.1  
Author: Dev2 - Test/QA Developer
Framework: PowerShell 5.1+
Security Standard: ISO/IEC 27001, OWASP Top 10
Purpose: é˜²å¾¡çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æï¼ˆæ”»æ’ƒçš„ãƒ„ãƒ¼ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰

.EXAMPLE
.\enhanced-security-vulnerability-test.ps1
åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ

.EXAMPLE
.\enhanced-security-vulnerability-test.ps1 -ScanLevel "Critical" -GenerateReport
é‡è¦åº¦é«˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®ã¿ã‚¹ã‚­ãƒ£ãƒ³
#>

[CmdletBinding()]
param(
    [ValidateSet("All", "Critical", "High", "Medium", "Low")]
    [string]$ScanLevel = "All",
    
    [string]$ProjectRoot = "E:\MicrosoftProductManagementTools",
    [string]$OutputPath = "TestReports",
    [switch]$GenerateReport = $true,
    [switch]$DetailedScan = $true
)

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
$ScanStartTime = Get-Date
$SessionId = Get-Date -Format "yyyyMMdd_HHmmss"

Write-Host "ğŸ”’ Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹" -ForegroundColor Red
Write-Host "ã‚¹ã‚­ãƒ£ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID: $SessionId" -ForegroundColor Yellow
Write-Host "ã‚¹ã‚­ãƒ£ãƒ³ãƒ¬ãƒ™ãƒ«: $ScanLevel" -ForegroundColor Yellow
Write-Host "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ: $ProjectRoot" -ForegroundColor Gray
Write-Host ""

# å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
$OutputDir = Join-Path $PSScriptRoot $OutputPath
if (-not (Test-Path $OutputDir)) {
    New-Item -ItemType Directory -Path $OutputDir -Force | Out-Null
}

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ
$SecurityResults = @{
    CriticalVulnerabilities = @()
    HighVulnerabilities = @()
    MediumVulnerabilities = @()
    LowVulnerabilities = @()
    ComplianceIssues = @()
    AuthenticationIssues = @()
    EncryptionIssues = @()
    InputValidationIssues = @()
    LoggingSecurityIssues = @()
    FilePermissionIssues = @()
    CodeInjectionRisks = @()
    InformationDisclosureRisks = @()
    TotalFilesScanned = 0
    TotalVulnerabilities = 0
    RiskScore = 0
}

# ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°
function Write-SecurityLog {
    param(
        [string]$Message,
        [ValidateSet("Info", "Warning", "Critical", "High", "Medium", "Low")]
        [string]$Level = "Info"
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $color = switch ($Level) {
        "Info" { "White" }
        "Warning" { "Yellow" }
        "Critical" { "Red" }
        "High" { "Magenta" }
        "Medium" { "Yellow" }
        "Low" { "Cyan" }
    }
    
    Write-Host "[$timestamp] [$Level] $Message" -ForegroundColor $color
}

# ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆè¿½åŠ 
function Add-VulnerabilityReport {
    param(
        [string]$Severity,
        [string]$Type,
        [string]$Description,
        [string]$FilePath,
        [int]$LineNumber = 0,
        [string]$Code = "",
        [string]$Recommendation = "",
        [string]$CWE = "",
        [string]$OWASP = ""
    )
    
    $vulnerability = [PSCustomObject]@{
        Severity = $Severity
        Type = $Type
        Description = $Description
        FilePath = $FilePath
        LineNumber = $LineNumber
        Code = $Code
        Recommendation = $Recommendation
        CWE = $CWE
        OWASP = $OWASP
        DetectedAt = Get-Date
        SessionId = $SessionId
    }
    
    switch ($Severity) {
        "Critical" { $SecurityResults.CriticalVulnerabilities += $vulnerability }
        "High" { $SecurityResults.HighVulnerabilities += $vulnerability }
        "Medium" { $SecurityResults.MediumVulnerabilities += $vulnerability }
        "Low" { $SecurityResults.LowVulnerabilities += $vulnerability }
    }
    
    $SecurityResults.TotalVulnerabilities++
}

Write-SecurityLog "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹ã—ã¾ã™" -Level "Info"

# 1. èªè¨¼ãƒ»èªå¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
Write-SecurityLog "èªè¨¼ãƒ»èªå¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..." -Level "Info"

$scriptFiles = Get-ChildItem -Path $ProjectRoot -Include "*.ps1", "*.psm1" -Recurse
$SecurityResults.TotalFilesScanned = $scriptFiles.Count

foreach ($file in $scriptFiles) {
    $content = Get-Content $file.FullName -Raw -ErrorAction SilentlyContinue
    if (-not $content) { continue }
    
    $lines = $content -split "`n"
    
    # A1. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã®æ¤œå‡º
    $credentialPatterns = @(
        @{ Pattern = "password\s*=\s*[`"'][^`"']+[`"']"; Severity = "Critical"; Type = "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"; CWE = "CWE-798"; OWASP = "A07-Identification and Authentication Failures" },
        @{ Pattern = "secret\s*=\s*[`"'][^`"']+[`"']"; Severity = "Critical"; Type = "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ"; CWE = "CWE-798"; OWASP = "A07-Identification and Authentication Failures" },
        @{ Pattern = "token\s*=\s*[`"'][^`"']+[`"']"; Severity = "High"; Type = "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³"; CWE = "CWE-798"; OWASP = "A07-Identification and Authentication Failures" },
        @{ Pattern = "key\s*=\s*[`"'][^`"']+[`"']"; Severity = "High"; Type = "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚­ãƒ¼"; CWE = "CWE-798"; OWASP = "A07-Identification and Authentication Failures" },
        @{ Pattern = "certificatepassword\s*=\s*[`"'][^`"']+[`"']"; Severity = "Critical"; Type = "ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸè¨¼æ˜æ›¸ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"; CWE = "CWE-798"; OWASP = "A07-Identification and Authentication Failures" }
    )
    
    foreach ($pattern in $credentialPatterns) {
        $matches = [regex]::Matches($content, $pattern.Pattern, [System.Text.RegularExpressions.RegexOptions]::IgnoreCase)
        foreach ($match in $matches) {
            $lineNumber = ($content.Substring(0, $match.Index) -split "`n").Count
            Add-VulnerabilityReport -Severity $pattern.Severity -Type $pattern.Type -Description "ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«èªè¨¼æƒ…å ±ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™" -FilePath $file.FullName -LineNumber $lineNumber -Code $match.Value -Recommendation "ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ Azure Key Vault ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„" -CWE $pattern.CWE -OWASP $pattern.OWASP
        }
    }
    
    # A2. å±é™ºãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
    $dangerousPatterns = @(
        @{ Pattern = "Invoke-Expression\s+\$"; Severity = "Critical"; Type = "ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³"; CWE = "CWE-78"; OWASP = "A03-Injection" },
        @{ Pattern = "IEX\s+\$"; Severity = "Critical"; Type = "ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³"; CWE = "CWE-78"; OWASP = "A03-Injection" },
        @{ Pattern = "cmd\s*/c\s+\$"; Severity = "High"; Type = "ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³"; CWE = "CWE-78"; OWASP = "A03-Injection" },
        @{ Pattern = "Start-Process.*\$\w+"; Severity = "High"; Type = "ãƒ—ãƒ­ã‚»ã‚¹ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³"; CWE = "CWE-78"; OWASP = "A03-Injection" },
        @{ Pattern = "Invoke-Command.*\$\w+"; Severity = "Medium"; Type = "ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ"; CWE = "CWE-78"; OWASP = "A03-Injection" }
    )
    
    foreach ($pattern in $dangerousPatterns) {
        $matches = [regex]::Matches($content, $pattern.Pattern, [System.Text.RegularExpressions.RegexOptions]::IgnoreCase)
        foreach ($match in $matches) {
            $lineNumber = ($content.Substring(0, $match.Index) -split "`n").Count
            Add-VulnerabilityReport -Severity $pattern.Severity -Type $pattern.Type -Description "ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ä½¿ç”¨ã—ãŸå±é™ºãªã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" -FilePath $file.FullName -LineNumber $lineNumber -Code $match.Value -Recommendation "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã•ã‚ŒãŸå®Ÿè¡Œã‚’ä½¿ç”¨ã—ã€å…¥åŠ›å€¤ã‚’æ¤œè¨¼ã—ã¦ãã ã•ã„" -CWE $pattern.CWE -OWASP $pattern.OWASP
        }
    }
    
    # A3. å…¥åŠ›æ¤œè¨¼ã®æ¬ å¦‚
    $inputValidationPatterns = @(
        @{ Pattern = "Read-Host.*\$\w+"; Severity = "Medium"; Type = "å…¥åŠ›æ¤œè¨¼ä¸å‚™"; CWE = "CWE-20"; OWASP = "A03-Injection" },
        @{ Pattern = "\$args\[\d+\]"; Severity = "Medium"; Type = "å¼•æ•°æ¤œè¨¼ä¸å‚™"; CWE = "CWE-20"; OWASP = "A03-Injection" },
        @{ Pattern = "param\s*\(.*\$\w+.*\)"; Severity = "Low"; Type = "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼ä¸å‚™"; CWE = "CWE-20"; OWASP = "A03-Injection" }
    )
    
    foreach ($pattern in $inputValidationPatterns) {
        $matches = [regex]::Matches($content, $pattern.Pattern, [System.Text.RegularExpressions.RegexOptions]::IgnoreCase)
        foreach ($match in $matches) {
            $lineNumber = ($content.Substring(0, $match.Index) -split "`n").Count
            Add-VulnerabilityReport -Severity $pattern.Severity -Type $pattern.Type -Description "å…¥åŠ›å€¤ã®æ¤œè¨¼ãŒä¸ååˆ†ã§ã™" -FilePath $file.FullName -LineNumber $lineNumber -Code $match.Value -Recommendation "ValidateSetã€ValidatePatternã€ValidateRangeå±æ€§ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„" -CWE $pattern.CWE -OWASP $pattern.OWASP
        }
    }
    
    # A4. æƒ…å ±æ¼æ´©ãƒªã‚¹ã‚¯
    $informationDisclosurePatterns = @(
        @{ Pattern = "Write-Host.*password"; Severity = "High"; Type = "æ©Ÿå¯†æƒ…å ±å‡ºåŠ›"; CWE = "CWE-200"; OWASP = "A01-Broken Access Control" },
        @{ Pattern = "Write-Output.*secret"; Severity = "High"; Type = "æ©Ÿå¯†æƒ…å ±å‡ºåŠ›"; CWE = "CWE-200"; OWASP = "A01-Broken Access Control" },
        @{ Pattern = "ConvertTo-SecureString.*-AsPlainText.*-Force"; Severity = "Medium"; Type = "å¹³æ–‡ã§ã®æ©Ÿå¯†æƒ…å ±å‡¦ç†"; CWE = "CWE-319"; OWASP = "A02-Cryptographic Failures" },
        @{ Pattern = "Write-Error.*\$_\.Exception\.Message"; Severity = "Low"; Type = "è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±éœ²å‡º"; CWE = "CWE-209"; OWASP = "A09-Security Logging and Monitoring Failures" }
    )
    
    foreach ($pattern in $informationDisclosurePatterns) {
        $matches = [regex]::Matches($content, $pattern.Pattern, [System.Text.RegularExpressions.RegexOptions]::IgnoreCase)
        foreach ($match in $matches) {
            $lineNumber = ($content.Substring(0, $match.Index) -split "`n").Count
            Add-VulnerabilityReport -Severity $pattern.Severity -Type $pattern.Type -Description "æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ãƒªã‚¹ã‚¯ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" -FilePath $file.FullName -LineNumber $lineNumber -Code $match.Value -Recommendation "æ©Ÿå¯†æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„" -CWE $pattern.CWE -OWASP $pattern.OWASP
        }
    }
    
    # A5. æš—å·åŒ–ã®å•é¡Œ
    if ($content -match "MD5|SHA1" -and $content -notmatch "# å¤ã„ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ„å›³çš„ã«ä½¿ç”¨") {
        Add-VulnerabilityReport -Severity "Medium" -Type "å¼±ã„æš—å·åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ " -Description "MD5ã¾ãŸã¯SHA1ãªã©ã€æš—å·å­¦çš„ã«å¼±ã„ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™" -FilePath $file.FullName -Recommendation "SHA-256ä»¥ä¸Šã®å¼·åŠ›ãªãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„" -CWE "CWE-327" -OWASP "A02-Cryptographic Failures"
    }
    
    # A6. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å•é¡Œ
    if ($content -match "-Credential\s+\$null" -or $content -match "-Username\s+`"`"") {
        Add-VulnerabilityReport -Severity "High" -Type "ç©ºã®èªè¨¼æƒ…å ±" -Description "ç©ºã¾ãŸã¯nullã®èªè¨¼æƒ…å ±ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™" -FilePath $file.FullName -Recommendation "é©åˆ‡ãªèªè¨¼æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„" -CWE "CWE-306" -OWASP "A07-Identification and Authentication Failures"
    }
    
    # A7. ãƒ­ã‚°è¨˜éŒ²ã®ä¸å‚™
    if ($content -match "catch\s*\{" -and $content -notmatch "Write-Log" -and $content -notmatch "Write-Error" -and $content -notmatch "Write-Warning") {
        Add-VulnerabilityReport -Severity "Medium" -Type "ä¾‹å¤–å‡¦ç†ã§ã®ãƒ­ã‚°è¨˜éŒ²ä¸å‚™" -Description "ä¾‹å¤–å‡¦ç†ã§ãƒ­ã‚°è¨˜éŒ²ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã›ã‚“" -FilePath $file.FullName -Recommendation "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’é©åˆ‡ã«ãƒ­ã‚°è¨˜éŒ²ã—ã¦ãã ã•ã„" -CWE "CWE-778" -OWASP "A09-Security Logging and Monitoring Failures"
    }
}

# 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
Write-SecurityLog "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..." -Level "Info"

$configFiles = Get-ChildItem -Path $ProjectRoot -Include "*.json", "*.xml", "*.config" -Recurse

foreach ($configFile in $configFiles) {
    $configContent = Get-Content $configFile.FullName -Raw -ErrorAction SilentlyContinue
    if (-not $configContent) { continue }
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å†…ã®æ©Ÿå¯†æƒ…å ±
    if ($configContent -match '"password"\s*:\s*"[^"]+"' -or $configContent -match '"secret"\s*:\s*"[^"]+"' -or $configContent -match '"token"\s*:\s*"[^"]+"') {
        Add-VulnerabilityReport -Severity "Critical" -Type "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å†…æ©Ÿå¯†æƒ…å ±" -Description "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«æ©Ÿå¯†æƒ…å ±ãŒå¹³æ–‡ã§ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™" -FilePath $configFile.FullName -Recommendation "Azure Key Vault ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„" -CWE "CWE-313" -OWASP "A02-Cryptographic Failures"
    }
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼æƒ…å ±ã®ä½¿ç”¨
    $defaultCredentials = @("admin", "password", "123456", "default", "test")
    foreach ($defaultCred in $defaultCredentials) {
        if ($configContent -match "`"$defaultCred`"") {
            Add-VulnerabilityReport -Severity "High" -Type "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèªè¨¼æƒ…å ±" -Description "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èªè¨¼æƒ…å ±ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™" -FilePath $configFile.FullName -Code $defaultCred -Recommendation "å¼·åŠ›ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªèªè¨¼æƒ…å ±ã«å¤‰æ›´ã—ã¦ãã ã•ã„" -CWE "CWE-798" -OWASP "A07-Identification and Authentication Failures"
        }
    }
}

# 3. ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
Write-SecurityLog "ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..." -Level "Info"

$sensitiveFiles = @(
    @{ Path = Join-Path $ProjectRoot "Config\appsettings.json"; Type = "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«" },
    @{ Path = Join-Path $ProjectRoot "Certificates"; Type = "è¨¼æ˜æ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª" },
    @{ Path = Join-Path $ProjectRoot "Logs"; Type = "ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª" }
)

foreach ($sensitiveItem in $sensitiveFiles) {
    if (Test-Path $sensitiveItem.Path) {
        try {
            $acl = Get-Acl $sensitiveItem.Path -ErrorAction SilentlyContinue
            
            # Everyone ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ç¢ºèª
            $everyoneAccess = $acl.Access | Where-Object { $_.IdentityReference -eq "Everyone" }
            if ($everyoneAccess) {
                Add-VulnerabilityReport -Severity "High" -Type "éåº¦ãªãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™" -Description "$($sensitiveItem.Type)ã«Everyoneã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™" -FilePath $sensitiveItem.Path -Recommendation "æœ€å°æ¨©é™ã®åŸå‰‡ã«å¾“ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’åˆ¶é™ã—ã¦ãã ã•ã„" -CWE "CWE-732" -OWASP "A01-Broken Access Control"
            }
            
            # Users ã‚°ãƒ«ãƒ¼ãƒ—ã®æ›¸ãè¾¼ã¿æ¨©é™ç¢ºèª
            $usersWriteAccess = $acl.Access | Where-Object { 
                $_.IdentityReference -match "Users" -and 
                ($_.FileSystemRights -match "Write|FullControl|Modify") 
            }
            if ($usersWriteAccess) {
                Add-VulnerabilityReport -Severity "Medium" -Type "å±é™ºãªãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™" -Description "$($sensitiveItem.Type)ã«Usersã‚°ãƒ«ãƒ¼ãƒ—ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™" -FilePath $sensitiveItem.Path -Recommendation "èª­ã¿å–ã‚Šå°‚ç”¨æ¨©é™ã«åˆ¶é™ã—ã¦ãã ã•ã„" -CWE "CWE-732" -OWASP "A01-Broken Access Control"
            }
        } catch {
            Write-SecurityLog "ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®ç¢ºèªã«å¤±æ•—: $($sensitiveItem.Path)" -Level "Warning"
        }
    }
}

# 4. ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
Write-SecurityLog "ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..." -Level "Info"

$moduleFiles = Get-ChildItem -Path $ProjectRoot -Include "*.psm1", "*.psd1" -Recurse

foreach ($moduleFile in $moduleFiles) {
    $moduleContent = Get-Content $moduleFile.FullName -Raw -ErrorAction SilentlyContinue
    if (-not $moduleContent) { continue }
    
    # å¤ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä½¿ç”¨
    if ($moduleContent -match "RequiredVersion\s*=\s*[`"']([0-9]+\.[0-9]+\.[0-9]+)[`"']") {
        $version = $matches[1]
        # ç°¡æ˜“çš„ãªå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆå®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯æ›´æ–°ã•ã‚ŒãŸè„†å¼±æ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ï¼‰
        if ($version -match "^[0-2]\." -or $version -match "^3\.[0-4]\.") {
            Add-VulnerabilityReport -Severity "Medium" -Type "å¤ã„ä¾å­˜é–¢ä¿‚" -Description "æ½œåœ¨çš„ã«è„†å¼±æ€§ã®ã‚ã‚‹å¤ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™" -FilePath $moduleFile.FullName -Code $version -Recommendation "æœ€æ–°ã®å®‰å…¨ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã—ã¦ãã ã•ã„" -CWE "CWE-1104" -OWASP "A06-Vulnerable and Outdated Components"
        }
    }
    
    # ä¿¡é ¼ã§ããªã„ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
    if ($moduleContent -match "Import-Module.*http://" -or $moduleContent -match "Import-Module.*ftp://") {
        Add-VulnerabilityReport -Severity "High" -Type "ä¿¡é ¼ã§ããªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚½ãƒ¼ã‚¹" -Description "HTTPã¾ãŸã¯FTPãªã©ã€å®‰å…¨ã§ãªã„ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™" -FilePath $moduleFile.FullName -Recommendation "HTTPSçµŒç”±ã¾ãŸã¯ç½²åæ¸ˆã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„" -CWE "CWE-494" -OWASP "A06-Vulnerable and Outdated Components"
    }
}

# 5. ISO/IEC 27001ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚¹ã‚­ãƒ£ãƒ³
Write-SecurityLog "ISO/IEC 27001ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­..." -Level "Info"

$configPath = Join-Path $ProjectRoot "Config\appsettings.json"
if (Test-Path $configPath) {
    $config = Get-Content $configPath -Raw | ConvertFrom-Json -ErrorAction SilentlyContinue
    
    if ($config) {
        # ç›£æŸ»è¨¼è·¡ã®æœ‰åŠ¹åŒ–ç¢ºèª
        if (-not $config.Security.EnableAuditTrail) {
            Add-VulnerabilityReport -Severity "High" -Type "ISO 27001é•å" -Description "ç›£æŸ»è¨¼è·¡ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ (A.12.4.1)" -FilePath $configPath -Recommendation "ç›£æŸ»è¨¼è·¡ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„" -CWE "CWE-778" -OWASP "A09-Security Logging and Monitoring Failures"
            $SecurityResults.ComplianceIssues += "A.12.4.1: ç›£æŸ»è¨¼è·¡æœªæœ‰åŠ¹åŒ–"
        }
        
        # MFAè¦æ±‚ã®ç¢ºèª
        if (-not $config.Security.RequireMFAForAdmins) {
            Add-VulnerabilityReport -Severity "High" -Type "ISO 27001é•å" -Description "ç®¡ç†è€…ã«å¯¾ã™ã‚‹MFAãŒè¦æ±‚ã•ã‚Œã¦ã„ã¾ã›ã‚“ (A.9.4.2)" -FilePath $configPath -Recommendation "ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ã«MFAã‚’è¦æ±‚ã—ã¦ãã ã•ã„" -CWE "CWE-308" -OWASP "A07-Identification and Authentication Failures"
            $SecurityResults.ComplianceIssues += "A.9.4.2: ç®¡ç†è€…MFAæœªè¦æ±‚"
        }
        
        # ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ã®ç¢ºèª
        if (-not $config.Security.EncryptSensitiveData) {
            Add-VulnerabilityReport -Severity "High" -Type "ISO 27001é•å" -Description "æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ (A.10.1.1)" -FilePath $configPath -Recommendation "æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„" -CWE "CWE-311" -OWASP "A02-Cryptographic Failures"
            $SecurityResults.ComplianceIssues += "A.10.1.1: ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–æœªæœ‰åŠ¹åŒ–"
        }
    }
}

# ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢è¨ˆç®—
$riskWeights = @{
    "Critical" = 10
    "High" = 7
    "Medium" = 4
    "Low" = 1
}

$SecurityResults.RiskScore = (
    ($SecurityResults.CriticalVulnerabilities.Count * $riskWeights.Critical) +
    ($SecurityResults.HighVulnerabilities.Count * $riskWeights.High) +
    ($SecurityResults.MediumVulnerabilities.Count * $riskWeights.Medium) +
    ($SecurityResults.LowVulnerabilities.Count * $riskWeights.Low)
)

# ã‚¹ã‚­ãƒ£ãƒ³çµæœè¡¨ç¤º
$ScanEndTime = Get-Date
$TotalDuration = ($ScanEndTime - $ScanStartTime).TotalSeconds

Write-Host ""
Write-Host "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ ===" -ForegroundColor Red
Write-Host "ã‚¹ã‚­ãƒ£ãƒ³æ™‚é–“: $([math]::Round($TotalDuration, 2)) ç§’" -ForegroundColor White
Write-Host "ã‚¹ã‚­ãƒ£ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $($SecurityResults.TotalFilesScanned)" -ForegroundColor White
Write-Host ""

Write-Host "ğŸš¨ è„†å¼±æ€§çµ±è¨ˆ:" -ForegroundColor Red
Write-Host "  é‡è¦: $($SecurityResults.CriticalVulnerabilities.Count)" -ForegroundColor Red
Write-Host "  é«˜: $($SecurityResults.HighVulnerabilities.Count)" -ForegroundColor Magenta  
Write-Host "  ä¸­: $($SecurityResults.MediumVulnerabilities.Count)" -ForegroundColor Yellow
Write-Host "  ä½: $($SecurityResults.LowVulnerabilities.Count)" -ForegroundColor Cyan
Write-Host "  åˆè¨ˆ: $($SecurityResults.TotalVulnerabilities)" -ForegroundColor White
Write-Host "  ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: $($SecurityResults.RiskScore)" -ForegroundColor $(if ($SecurityResults.RiskScore -gt 50) { "Red" } elseif ($SecurityResults.RiskScore -gt 20) { "Yellow" } else { "Green" })
Write-Host ""

if ($SecurityResults.ComplianceIssues.Count -gt 0) {
    Write-Host "ğŸ“œ ISO/IEC 27001ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å•é¡Œ:" -ForegroundColor Yellow
    foreach ($issue in $SecurityResults.ComplianceIssues) {
        Write-Host "  â€¢ $issue" -ForegroundColor White
    }
    Write-Host ""
}

# é‡è¦ãªè„†å¼±æ€§ã®è¡¨ç¤º
if ($SecurityResults.CriticalVulnerabilities.Count -gt 0) {
    Write-Host "ğŸ”´ é‡è¦ãªè„†å¼±æ€§ (è¦ç·Šæ€¥å¯¾å¿œ):" -ForegroundColor Red
    foreach ($vuln in $SecurityResults.CriticalVulnerabilities | Select-Object -First 5) {
        Write-Host "  â€¢ $($vuln.Type): $($vuln.Description)" -ForegroundColor Red
        Write-Host "    ãƒ•ã‚¡ã‚¤ãƒ«: $($vuln.FilePath)" -ForegroundColor Gray
        if ($vuln.LineNumber -gt 0) {
            Write-Host "    è¡Œ: $($vuln.LineNumber)" -ForegroundColor Gray
        }
        Write-Host "    æ¨å¥¨å¯¾å¿œ: $($vuln.Recommendation)" -ForegroundColor Yellow
        Write-Host ""
    }
}

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
if ($GenerateReport) {
    Write-SecurityLog "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™" -Level "Info"
    
    # CSV ãƒ¬ãƒãƒ¼ãƒˆ
    $csvPath = Join-Path $OutputDir "security-vulnerability-report_$SessionId.csv"
    $allVulnerabilities = $SecurityResults.CriticalVulnerabilities + $SecurityResults.HighVulnerabilities + $SecurityResults.MediumVulnerabilities + $SecurityResults.LowVulnerabilities
    $allVulnerabilities | Export-Csv -Path $csvPath -NoTypeInformation -Encoding UTF8
    
    # JSON ãƒ¬ãƒãƒ¼ãƒˆï¼ˆè©³ç´°ï¼‰
    $jsonPath = Join-Path $OutputDir "security-vulnerability-report_$SessionId.json"
    $SecurityResults | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonPath -Encoding UTF8
    
    # HTML ãƒ¬ãƒãƒ¼ãƒˆ
    $htmlPath = Join-Path $OutputDir "security-vulnerability-report_$SessionId.html"
    $htmlContent = @"
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆ - $SessionId</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #dc3545; }
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .alert-critical { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .alert-high { background-color: #f1c0f7; border: 1px solid #e1bee7; color: #4a1a4a; }
        .alert-medium { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .alert-low { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .metric { display: inline-block; margin: 10px; padding: 15px; border-radius: 5px; text-align: center; min-width: 120px; color: white; }
        .metric-critical { background-color: #dc3545; }
        .metric-high { background-color: #e91e63; }
        .metric-medium { background-color: #ff9800; }
        .metric-low { background-color: #17a2b8; }
        .metric-info { background-color: #6c757d; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #dc3545; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .vulnerability-critical { background-color: #ffebee; }
        .vulnerability-high { background-color: #fce4ec; }
        .vulnerability-medium { background-color: #fff8e1; }
        .vulnerability-low { background-color: #e0f2f1; }
        .recommendation { background-color: #e8f5e8; border: 1px solid #c3e6cb; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .risk-score { font-size: 24px; font-weight: bold; text-align: center; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .risk-high { background-color: #ffcdd2; color: #c62828; }
        .risk-medium { background-color: #fff3e0; color: #ef6c00; }
        .risk-low { background-color: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <p><strong>ã‚¹ã‚­ãƒ£ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³:</strong> $SessionId</p>
        <p><strong>å®Ÿè¡Œæ™‚é–“:</strong> $([math]::Round($TotalDuration, 2)) ç§’</p>
        <p><strong>ã‚¹ã‚­ãƒ£ãƒ³æ—¥æ™‚:</strong> $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
        <p><strong>ã‚¹ã‚­ãƒ£ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«æ•°:</strong> $($SecurityResults.TotalFilesScanned)</p>
        
        <h2>ğŸ“Š è„†å¼±æ€§çµ±è¨ˆ</h2>
        <div>
            <div class="metric metric-critical">
                <div style="font-size: 24px;">$($SecurityResults.CriticalVulnerabilities.Count)</div>
                <div>é‡è¦</div>
            </div>
            <div class="metric metric-high">
                <div style="font-size: 24px;">$($SecurityResults.HighVulnerabilities.Count)</div>
                <div>é«˜</div>
            </div>
            <div class="metric metric-medium">
                <div style="font-size: 24px;">$($SecurityResults.MediumVulnerabilities.Count)</div>
                <div>ä¸­</div>
            </div>
            <div class="metric metric-low">
                <div style="font-size: 24px;">$($SecurityResults.LowVulnerabilities.Count)</div>
                <div>ä½</div>
            </div>
            <div class="metric metric-info">
                <div style="font-size: 24px;">$($SecurityResults.TotalVulnerabilities)</div>
                <div>åˆè¨ˆ</div>
            </div>
        </div>
        
        <div class="risk-score $(if ($SecurityResults.RiskScore -gt 50) { 'risk-high' } elseif ($SecurityResults.RiskScore -gt 20) { 'risk-medium' } else { 'risk-low' })">
            ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: $($SecurityResults.RiskScore)
        </div>
"@
    
    # ISO/IEC 27001ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å•é¡Œ
    if ($SecurityResults.ComplianceIssues.Count -gt 0) {
        $htmlContent += "<h2>ğŸ“œ ISO/IEC 27001 ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å•é¡Œ</h2>`n"
        foreach ($issue in $SecurityResults.ComplianceIssues) {
            $htmlContent += "<div class='alert alert-high'>âš–ï¸ $issue</div>`n"
        }
    }
    
    # é‡è¦ãªè„†å¼±æ€§
    if ($SecurityResults.CriticalVulnerabilities.Count -gt 0) {
        $htmlContent += "<h2>ğŸš¨ é‡è¦ãªè„†å¼±æ€§ (è¦ç·Šæ€¥å¯¾å¿œ)</h2>`n"
        foreach ($vuln in $SecurityResults.CriticalVulnerabilities) {
            $htmlContent += @"
            <div class="alert alert-critical">
                <h4>$($vuln.Type)</h4>
                <p><strong>èª¬æ˜:</strong> $($vuln.Description)</p>
                <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«:</strong> $($vuln.FilePath)$(if ($vuln.LineNumber -gt 0) { " (è¡Œ: $($vuln.LineNumber))" })</p>
                $(if ($vuln.Code) { "<p><strong>ã‚³ãƒ¼ãƒ‰:</strong> <code>$($vuln.Code)</code></p>" })
                <div class="recommendation">ğŸ’¡ <strong>æ¨å¥¨å¯¾å¿œ:</strong> $($vuln.Recommendation)</div>
                $(if ($vuln.CWE) { "<p><strong>CWE:</strong> $($vuln.CWE)</p>" })
                $(if ($vuln.OWASP) { "<p><strong>OWASP:</strong> $($vuln.OWASP)</p>" })
            </div>
"@
        }
    }
    
    # è„†å¼±æ€§è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
    $htmlContent += @"
        <h2>ğŸ“‹ è„†å¼±æ€§è©³ç´°</h2>
        <table>
            <tr>
                <th>é‡è¦åº¦</th>
                <th>ã‚¿ã‚¤ãƒ—</th>
                <th>èª¬æ˜</th>
                <th>ãƒ•ã‚¡ã‚¤ãƒ«</th>
                <th>è¡Œ</th>
                <th>æ¨å¥¨å¯¾å¿œ</th>
            </tr>
"@
    
    foreach ($vuln in $allVulnerabilities) {
        $severityClass = "vulnerability-$($vuln.Severity.ToLower())"
        $htmlContent += @"
            <tr class="$severityClass">
                <td>$($vuln.Severity)</td>
                <td>$($vuln.Type)</td>
                <td>$($vuln.Description)</td>
                <td>$($vuln.FilePath)</td>
                <td>$(if ($vuln.LineNumber -gt 0) { $vuln.LineNumber } else { "-" })</td>
                <td>$($vuln.Recommendation)</td>
            </tr>
"@
    }
    
    $htmlContent += @"
        </table>
        
        <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #6c757d;">
            <p>Generated by Dev2 - Test/QA Developer | Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ†ã‚¹ãƒˆ</p>
            <p>Report ID: $SessionId | Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
            <p>Security Standards: ISO/IEC 27001, OWASP Top 10 | é˜²å¾¡çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ</p>
        </footer>
    </div>
</body>
</html>
"@
    
    $htmlContent | Out-File -FilePath $htmlPath -Encoding UTF8
    
    Write-SecurityLog "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ:" -Level "Info"
    Write-SecurityLog "  CSV: $csvPath" -Level "Info"
    Write-SecurityLog "  JSON: $jsonPath" -Level "Info"
    Write-SecurityLog "  HTML: $htmlPath" -Level "Info"
}

# çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
Write-Host ""
if ($SecurityResults.CriticalVulnerabilities.Count -gt 0) {
    Write-Host "ğŸ”´ é‡è¦ãªè„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ ($($SecurityResults.CriticalVulnerabilities.Count) ä»¶)" -ForegroundColor Red
    Write-Host "ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™" -ForegroundColor Red
    $exitCode = 2
} elseif ($SecurityResults.HighVulnerabilities.Count -gt 0) {
    Write-Host "ğŸŸ  é«˜é‡è¦åº¦ã®è„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ ($($SecurityResults.HighVulnerabilities.Count) ä»¶)" -ForegroundColor Yellow
    Write-Host "å„ªå…ˆå¯¾å¿œãŒæ¨å¥¨ã•ã‚Œã¾ã™" -ForegroundColor Yellow
    $exitCode = 1
} else {
    Write-Host "ğŸŸ¢ é‡è¦ãƒ»é«˜é‡è¦åº¦ã®è„†å¼±æ€§ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" -ForegroundColor Green
    $exitCode = 0
}

Write-Host "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†: $([math]::Round($TotalDuration, 2)) ç§’" -ForegroundColor Gray
Write-Host "ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: $($SecurityResults.RiskScore)" -ForegroundColor $(if ($SecurityResults.RiskScore -gt 50) { "Red" } elseif ($SecurityResults.RiskScore -gt 20) { "Yellow" } else { "Green" })

exit $exitCode