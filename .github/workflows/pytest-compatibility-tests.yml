name: Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« - pytestäº’æ›æ€§ãƒ†ã‚¹ãƒˆ

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'Tests/**'
      - 'pytest.ini'
      - 'requirements.txt'
      - '.github/workflows/pytest-compatibility-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'Tests/**'
      - 'pytest.ini'
      - 'requirements.txt'
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJST 11æ™‚ï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒªé¸æŠ'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - compatibility
          - gui
      skip_powershell:
        description: 'PowerShellå¿…é ˆãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: false
        type: boolean
      verbose_output:
        description: 'è©³ç´°å‡ºåŠ›ã‚’æœ‰åŠ¹åŒ–'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  POWERSHELL_VERSION: '7.5.1'

jobs:
  setup:
    name: ğŸ”§ ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.setup.outputs.python-version }}
      test-category: ${{ steps.setup.outputs.test-category }}
      skip-powershell: ${{ steps.setup.outputs.skip-powershell }}
      verbose: ${{ steps.setup.outputs.verbose }}
    steps:
      - name: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ±ºå®š
        id: setup
        run: |
          echo "python-version=${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT
          echo "test-category=${{ github.event.inputs.test_category || 'all' }}" >> $GITHUB_OUTPUT
          echo "skip-powershell=${{ github.event.inputs.skip_powershell || 'false' }}" >> $GITHUB_OUTPUT
          echo "verbose=${{ github.event.inputs.verbose_output || 'true' }}" >> $GITHUB_OUTPUT

  lint-and-format:
    name: ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ (Black)
        run: |
          black --check --diff src/ Tests/
        continue-on-error: true

      - name: ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ (flake8)
        run: |
          flake8 src/ Tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ Tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: å‹ãƒã‚§ãƒƒã‚¯ (mypy)
        run: |
          mypy src/ --ignore-missing-imports
        continue-on-error: true

  unit-tests:
    name: ğŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    runs-on: ${{ matrix.os }}
    needs: [setup, lint-and-format]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.9', '3.11', '3.12']
        exclude:
          # Windows + Python 3.9 ã®çµ„ã¿åˆã‚ã›ã¯é™¤å¤–ï¼ˆäº’æ›æ€§å•é¡Œï¼‰
          - os: windows-latest
            python-version: '3.9'
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: PowerShell ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $PSVersionTable
          # PowerShell 7.5.1 ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if ($PSVersionTable.PSVersion.Major -lt 7) {
            Write-Host "PowerShell 7.5.1 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
            # PowerShell 7 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
            iex "& { $(irm https://aka.ms/install-powershell.ps1) } -UseMSI"
          }

      - name: PowerShell ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # PowerShell 7.5.1 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell
          pwsh --version

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
        run: |
          mkdir -p TestScripts/TestReports
          mkdir -p tests/logs
          mkdir -p tests/temp

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          python Tests/run_test_suite.py --category unit --verbose=${{ needs.setup.outputs.verbose }}
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            TestScripts/TestReports/unit-*
            tests/logs/
          retention-days: 30

  integration-tests:
    name: ğŸ”— çµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: ${{ matrix.os }}
    needs: [setup, unit-tests]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            test-timeout: 1800
          - os: windows-latest
            test-timeout: 2400
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          cache: 'pip'

      - name: PowerShell ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $PSVersionTable

      - name: PowerShell ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
        run: |
          mkdir -p TestScripts/TestReports
          mkdir -p tests/logs
          mkdir -p tests/temp

      - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 30
        run: |
          python Tests/run_test_suite.py --category integration --verbose=${{ needs.setup.outputs.verbose }}
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results-${{ matrix.os }}
          path: |
            TestScripts/TestReports/integration-*
            tests/logs/
          retention-days: 30

  compatibility-tests:
    name: ğŸ¤ äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
    runs-on: ${{ matrix.os }}
    needs: [setup, unit-tests]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        test-type: [output-format, api-response, powershell-bridge]
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          cache: 'pip'

      - name: PowerShell ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        shell: pwsh
        run: |
          $PSVersionTable
          # PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèª
          Get-InstalledModule -Name Microsoft.Graph -ErrorAction SilentlyContinue
          Get-InstalledModule -Name ExchangeOnlineManagement -ErrorAction SilentlyContinue

      - name: PowerShell ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
        run: |
          mkdir -p TestScripts/TestReports
          mkdir -p tests/logs
          mkdir -p tests/temp

      - name: äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 45
        run: |
          python Tests/run_test_suite.py --category compatibility \
            --skip-powershell=${{ needs.setup.outputs.skip-powershell }} \
            --verbose=${{ needs.setup.outputs.verbose }}
        env:
          PYTHONPATH: ${{ github.workspace }}
          TEST_TYPE: ${{ matrix.test-type }}

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: compatibility-test-results-${{ matrix.os }}-${{ matrix.test-type }}
          path: |
            TestScripts/TestReports/compatibility-*
            tests/logs/
            tests/temp/
          retention-days: 30

  gui-tests:
    name: ğŸ–¥ï¸ GUIãƒ†ã‚¹ãƒˆ
    runs-on: ${{ matrix.os }}
    needs: [setup, unit-tests]
    if: ${{ needs.setup.outputs.test-category == 'all' || needs.setup.outputs.test-category == 'gui' }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          cache: 'pip'

      - name: GUI ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb qt6-base-dev
          # ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤è¨­å®š
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
        run: |
          mkdir -p TestScripts/TestReports
          mkdir -p tests/logs

      - name: GUIãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 20
        run: |
          python Tests/run_test_suite.py --category gui --verbose=${{ needs.setup.outputs.verbose }}
        env:
          PYTHONPATH: ${{ github.workspace }}
          QT_QPA_PLATFORM: offscreen
          DISPLAY: :99

      - name: GUIãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: gui-test-screenshots-${{ matrix.os }}
          path: tests/temp/screenshots/
          retention-days: 7

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: gui-test-results-${{ matrix.os }}
          path: |
            TestScripts/TestReports/gui-*
            tests/logs/
          retention-days: 30

  comprehensive-tests:
    name: ğŸš€ åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: [setup, unit-tests, integration-tests, compatibility-tests]
    if: ${{ needs.setup.outputs.test-category == 'all' }}
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}
          cache: 'pip'

      - name: PowerShell ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
        run: |
          mkdir -p TestScripts/TestReports
          mkdir -p tests/logs
          mkdir -p tests/temp

      - name: åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 60
        run: |
          python Tests/run_test_suite.py --category all \
            --skip-powershell=${{ needs.setup.outputs.skip-powershell }} \
            --skip-gui=true \
            --verbose=${{ needs.setup.outputs.verbose }}
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          coverage combine
          coverage report --show-missing
          coverage html
          coverage xml

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: pytest-compatibility
          name: Microsoft365-Tools-Coverage

      - name: åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: comprehensive-test-results
          path: |
            TestScripts/TestReports/comprehensive-*
            htmlcov/
            tests/logs/
            coverage.xml
          retention-days: 90

  security-scan:
    name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ needs.setup.outputs.python-version }}

      - name: ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          safety check --json --output safety-report.json || true
          cat safety-report.json

      - name: ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          cat bandit-report.json

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-scan-results
          path: |
            safety-report.json
            bandit-report.json
          retention-days: 30

  deploy-reports:
    name: ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆé…å¸ƒ
    runs-on: ubuntu-latest
    needs: [comprehensive-tests, security-scan]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å…¨ãƒ†ã‚¹ãƒˆçµæœãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          path: test-results

      - name: ãƒ¬ãƒãƒ¼ãƒˆçµ±åˆ
        run: |
          mkdir -p public/reports
          find test-results -name "*.html" -exec cp {} public/reports/ \;
          find test-results -name "*.json" -exec cp {} public/reports/ \;
          
          # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¸ç”Ÿæˆ
          echo "<!DOCTYPE html><html><head><title>Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</title></head><body>" > public/index.html
          echo "<h1>Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« - ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</h1>" >> public/index.html
          echo "<ul>" >> public/index.html
          for file in public/reports/*.html; do
            basename=$(basename "$file")
            echo "<li><a href=\"reports/$basename\">$basename</a></li>" >> public/index.html
          done
          echo "</ul></body></html>" >> public/index.html

      - name: GitHub Pagesé…å¸ƒ
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: test-reports

  notification:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [comprehensive-tests, security-scan, deploy-reports]
    if: always()
    
    steps:
      - name: ãƒ†ã‚¹ãƒˆçµæœé€šçŸ¥
        if: failure()
        run: |
          echo "âŒ Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« pytestäº’æ›æ€§ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
      - name: æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« pytestäº’æ›æ€§ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
          echo "ãƒ¬ãƒãƒ¼ãƒˆ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"