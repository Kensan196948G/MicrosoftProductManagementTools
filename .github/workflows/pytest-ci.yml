name: Microsoft 365ç®¡ç†ãƒ„ãƒ¼ãƒ« - pytest CI/CD Pipeline
# Dev1 - Test/QA Developer ã«ã‚ˆã‚‹åŸºç›¤æ§‹ç¯‰

on:
  push:
    branches: [ main, develop, feature/*, hotfix/* ]
    paths:
      - 'src/**'
      - 'Tests/**'
      - 'tests/**'
      - 'pytest.ini'
      - 'conftest.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'Makefile'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'Tests/**'
      - 'tests/**'
      - 'pytest.ini'
      - 'conftest.py'
      - 'requirements.txt'
      - 'pyproject.toml'
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆJSTï¼‰
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - compatibility
          - gui
          - security
          - performance
      skip_powershell:
        description: 'Skip PowerShell compatibility tests'
        required: false
        default: true
        type: boolean
      skip_auth:
        description: 'Skip authentication required tests'
        required: false
        default: true
        type: boolean
      verbose:
        description: 'Verbose output'
        required: false
        default: true
        type: boolean

env:
  PYTHONUNBUFFERED: 1
  PYTEST_TIMEOUT: 1800
  COVERAGE_THRESHOLD: 80
  PYTHON_VERSION_MATRIX: "['3.9', '3.10', '3.11', '3.12']"

jobs:
  unit-tests:
    name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ æ¤œè¨¼
      run: |
        echo "::group::ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ æ¤œè¨¼"
        
        # å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¤œè¨¼
        required_dirs=("src" "Tests" "tests")
        missing_dirs=()
        
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            missing_dirs+=("$dir")
            echo "::warning::å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $dir"
          else
            echo "âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª: $dir"
          fi
        done
        
        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        required_files=("requirements.txt" "pytest.ini" "pyproject.toml")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: $file"
          elif [ -f "Tests/$file" ]; then
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª: Tests/$file"
          else
            echo "::notice::ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«æœªæ¤œå‡º: $file"
          fi
        done
        
        # ç’°å¢ƒå¤‰æ•°è¨­å®š
        echo "STRUCTURE_VALIDATED=true" >> $GITHUB_ENV
        if [ ${#missing_dirs[@]} -gt 0 ]; then
          echo "MISSING_DIRS=${missing_dirs[*]}" >> $GITHUB_ENV
          echo "::warning::ä¸€éƒ¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing_dirs[*]}"
        fi
        
        echo "::endgroup::"
    
    - name: Python ${{ matrix.python-version }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        check-latest: true
    
    - name: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          x11-utils \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        if [ -f "Tests/requirements.txt" ]; then
          pip install -r Tests/requirements.txt
        elif [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
          pip install -e .
        fi
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        pip install bandit safety
    
    - name: ğŸ§¹ ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå®Ÿè¡Œå‰ï¼‰
      run: |
        echo "::group::ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        rm -rf __pycache__ .pytest_cache .coverage htmlcov/ .mypy_cache/
        find . -name "*.pyc" -delete 2>/dev/null || true
        find . -name "*.pyo" -delete 2>/dev/null || true
        find . -name "*~" -delete 2>/dev/null || true
        
        # ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆæœŸåŒ–
        mkdir -p test-outputs
        rm -rf test-outputs/* 2>/dev/null || true
        
        # ç’°å¢ƒå¤‰æ•°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        unset PYTHONPATH
        export PYTHONDONTWRITEBYTECODE=1
        export PYTEST_CURRENT_TEST=""
        
        echo "âœ… ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
        echo "::endgroup::"
    
    - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      timeout-minutes: 30
      run: |
        echo "::group::ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        
        # ãƒ†ã‚¹ãƒˆåˆ†é›¢å®Ÿè¡Œ
        if [ -d "tests/unit" ] || [ -d "Tests/unit" ]; then
          test_dir="tests/unit"
          [ ! -d "$test_dir" ] && test_dir="Tests/unit"
          
          echo "ğŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹: $test_dir"
          
          xvfb-run -a python -m pytest "$test_dir" \
            -v \
            --tb=short \
            --strict-markers \
            --strict-config \
            --cov=src \
            --cov-report=xml:test-outputs/coverage-unit-py${{ matrix.python-version }}.xml \
            --cov-report=html:test-outputs/htmlcov-unit-py${{ matrix.python-version }} \
            --cov-report=json:test-outputs/coverage-unit-py${{ matrix.python-version }}.json \
            --junitxml=test-outputs/unit-test-results-py${{ matrix.python-version }}.xml \
            --html=test-outputs/unit-test-report-py${{ matrix.python-version }}.html \
            --self-contained-html \
            --durations=10 \
            --maxfail=5 \
            --tb=line \
            -m "unit and not requires_auth and not requires_powershell" \
            || echo "::error::ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§å¤±æ•—ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        else
          echo "::warning::ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "UNIT_TESTS_SKIPPED=true" >> $GITHUB_ENV
        fi
        
        echo "::endgroup::"
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: :99
    
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
      run: |
        echo "::group::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³"
        
        # Banditã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        bandit -r Scripts/ --format json -o bandit-security-report.json || true
        bandit -r Scripts/ --format txt || true
        
        # Safetyã«ã‚ˆã‚‹ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³  
        safety check --json --output safety-report.json || true
        safety check || true
        
        echo "::endgroup::"
    
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å“è³ªã‚²ãƒ¼ãƒˆ
      run: |
        echo "::group::ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å“è³ªã‚²ãƒ¼ãƒˆæ¤œè¨¼"
        
        # é«˜é‡è¦åº¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®å­˜åœ¨ç¢ºèª
        if [ -f "bandit-security-report.json" ]; then
          HIGH_ISSUES=$(python3 -c "
import json
try:
    with open('bandit-security-report.json', 'r') as f:
        data = json.load(f)
        high_issues = [r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']
        print(len(high_issues))
except:
    print('0')
")
          echo "é«˜é‡è¦åº¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œæ•°: $HIGH_ISSUES"
          
          if [ "$HIGH_ISSUES" -gt "0" ]; then
            echo "::error::é«˜é‡è¦åº¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
            exit 1
          else
            echo "âœ… é«˜é‡è¦åº¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œãªã—"
          fi
        fi
        
        echo "::endgroup::"
    
    - name: ã‚«ãƒãƒ¬ãƒƒã‚¸çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage-unit-py${{ matrix.python-version }}.xml
        flags: unittests
        name: unit-tests-python-${{ matrix.python-version }}
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
    
    - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results-python-${{ matrix.python-version }}
        path: |
          unit-test-results-py${{ matrix.python-version }}.xml
          unit-test-report-py${{ matrix.python-version }}.html
          htmlcov-unit-py${{ matrix.python-version }}/
          coverage-unit-py${{ matrix.python-version }}.xml
          coverage-unit-py${{ matrix.python-version }}.json
        retention-days: 30

  integration-tests:
    name: çµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: unit-tests
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11-utils
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        xvfb-run -a python -m pytest tests/integration \
          -v \
          --tb=short \
          --junitxml=integration-test-results.xml \
          --html=integration-test-report.html \
          --self-contained-html \
          --maxfail=5 \
          -m "integration and not requires_auth" || true
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: :99
    
    - name: çµ±åˆãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration-test-results.xml
          integration-test-report.html
        retention-days: 30

  compatibility-tests:
    name: äº’æ›æ€§ãƒ†ã‚¹ãƒˆï¼ˆPowerShellãªã—ï¼‰
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆPowerShellã‚¹ã‚­ãƒƒãƒ—ï¼‰
      run: |
        python -m pytest tests/compatibility \
          -v \
          --tb=short \
          --junitxml=compatibility-test-results.xml \
          --html=compatibility-test-report.html \
          --self-contained-html \
          -m "compatibility and not requires_powershell and not requires_auth"
    
    - name: äº’æ›æ€§ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: compatibility-test-results
        path: |
          compatibility-test-results.xml
          compatibility-test-report.html
        retention-days: 30

  gui-tests:
    name: GUIãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          x11-utils \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          libegl1-mesa \
          libxkbcommon0 \
          libxkbcommon-x11-0 \
          libfontconfig1 \
          libfreetype6 \
          libx11-6 \
          libx11-xcb1 \
          libxext6 \
          libxfixes3 \
          libxi6 \
          libxrender1 \
          libxcb1 \
          libxcb-glx0 \
          libxcb-render0 \
          libgl1-mesa-glx \
          libglib2.0-0
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: GUIãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        xvfb-run -a python -m pytest tests/ \
          -v \
          --tb=short \
          --junitxml=gui-test-results.xml \
          --html=gui-test-report.html \
          --self-contained-html \
          -m "gui and not requires_auth"
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: :99
        QT_LOGGING_RULES: '*.debug=false'
    
    - name: GUIãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gui-test-results
        path: |
          gui-test-results.xml
          gui-test-report.html
        retention-days: 30

  windows-compatibility:
    name: Windowsäº’æ›æ€§ãƒ†ã‚¹ãƒˆ
    runs-on: windows-latest
    needs: unit-tests
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: PowerShell Core ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        winget install Microsoft.PowerShell
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: Windows ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        python -m pytest tests/unit tests/compatibility \
          -v \
          --tb=short \
          --junitxml=windows-test-results.xml \
          --html=windows-test-report.html \
          --self-contained-html \
          -m "unit or compatibility and not requires_auth"
    
    - name: Windows ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-test-results
        path: |
          windows-test-results.xml
          windows-test-report.html
        retention-days: 30

  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Bandit ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -f txt
    
    - name: Safety ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
      run: |
        safety check --output json > safety-report.json || true
        safety check
    
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 90

  code-quality:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy
        pip install -r requirements.txt
    
    - name: Black ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      run: |
        black --check --diff src/ Tests/ || echo "Black formatting check completed"
    
    - name: Flake8 ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
      run: |
        flake8 src/ Tests/ --max-line-length=100 --ignore=E501,W503 || echo "Flake8 linting completed"
    
    - name: MyPy å‹ãƒã‚§ãƒƒã‚¯
      run: |
        mypy src/ --ignore-missing-imports || true

  comprehensive-report:
    name: åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, compatibility-tests, gui-tests, security-scan, code-quality]
    if: always()
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å…¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      run: |
        python tests/run_test_suite.py --report-only || echo "Test suite completed with warnings"
    
    - name: åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-ci-report
        path: |
          TestScripts/TestReports/comprehensive-test-report_*.html
          TestScripts/TestReports/comprehensive-test-summary_*.csv
          TestScripts/TestReports/comprehensive-test-data_*.json
        retention-days: 90

  deploy-docs:
    name: ãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¬é–‹
    runs-on: ubuntu-latest
    needs: comprehensive-report
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: comprehensive-ci-report
        path: docs/test-reports/
    
    - name: GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        destination_dir: test-reports