name: Microsoft 365管理ツール - pytest CI/CD Pipeline
# Dev1 - Test/QA Developer による基盤構築

on:
  push:
    branches: [ main, develop, feature/*, hotfix/* ]
    paths:
      - 'src/**'
      - 'Tests/**'
      - 'tests/**'
      - 'pytest.ini'
      - 'conftest.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'Makefile'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'Tests/**'
      - 'tests/**'
      - 'pytest.ini'
      - 'conftest.py'
      - 'requirements.txt'
      - 'pyproject.toml'
  schedule:
    # 毎日午前2時にテスト実行（JST）
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - compatibility
          - gui
          - security
          - performance
      skip_powershell:
        description: 'Skip PowerShell compatibility tests'
        required: false
        default: true
        type: boolean
      skip_auth:
        description: 'Skip authentication required tests'
        required: false
        default: true
        type: boolean
      verbose:
        description: 'Verbose output'
        required: false
        default: true
        type: boolean

env:
  PYTHONUNBUFFERED: 1
  PYTEST_TIMEOUT: 1800
  COVERAGE_THRESHOLD: 80
  PYTHON_VERSION_MATRIX: "['3.9', '3.10', '3.11', '3.12']"

jobs:
  unit-tests:
    name: ユニットテスト
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: 📁 ファイル構造検証
      run: |
        echo "::group::ファイル構造検証"
        
        # 必須ディレクトリ検証
        required_dirs=("src" "Tests" "tests")
        missing_dirs=()
        
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            missing_dirs+=("$dir")
            echo "::warning::必須ディレクトリが見つかりません: $dir"
          else
            echo "✅ ディレクトリ確認: $dir"
          fi
        done
        
        # 必須ファイル検証
        required_files=("requirements.txt" "pytest.ini" "pyproject.toml")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ ファイル確認: $file"
          elif [ -f "Tests/$file" ]; then
            echo "✅ ファイル確認: Tests/$file"
          else
            echo "::notice::オプションファイル未検出: $file"
          fi
        done
        
        # 環境変数設定
        echo "STRUCTURE_VALIDATED=true" >> $GITHUB_ENV
        if [ ${#missing_dirs[@]} -gt 0 ]; then
          echo "MISSING_DIRS=${missing_dirs[*]}" >> $GITHUB_ENV
          echo "::warning::一部ディレクトリが見つかりません: ${missing_dirs[*]}"
        fi
        
        echo "::endgroup::"
    
    - name: Python ${{ matrix.python-version }} セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        check-latest: true
    
    - name: システム依存関係インストール
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          x11-utils \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0
    
    - name: Python依存関係インストール
      run: |
        python -m pip install --upgrade pip
        if [ -f "Tests/requirements.txt" ]; then
          pip install -r Tests/requirements.txt
        elif [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi
        if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
          pip install -e .
        fi
        # セキュリティツール追加インストール
        pip install bandit safety
    
    - name: 🧹 テスト環境クリーンアップ（実行前）
      run: |
        echo "::group::テスト環境クリーンアップ"
        
        # 一時ファイル・ディレクトリクリーンアップ
        rm -rf __pycache__ .pytest_cache .coverage htmlcov/ .mypy_cache/
        find . -name "*.pyc" -delete 2>/dev/null || true
        find . -name "*.pyo" -delete 2>/dev/null || true
        find . -name "*~" -delete 2>/dev/null || true
        
        # テスト出力ディレクトリ初期化
        mkdir -p test-outputs
        rm -rf test-outputs/* 2>/dev/null || true
        
        # 環境変数クリーンアップ
        unset PYTHONPATH
        export PYTHONDONTWRITEBYTECODE=1
        export PYTEST_CURRENT_TEST=""
        
        echo "✅ テスト環境クリーンアップ完了"
        echo "::endgroup::"
    
    - name: ユニットテスト実行
      timeout-minutes: 30
      run: |
        echo "::group::ユニットテスト実行"
        
        # テスト分離実行
        if [ -d "tests/unit" ] || [ -d "Tests/unit" ]; then
          test_dir="tests/unit"
          [ ! -d "$test_dir" ] && test_dir="Tests/unit"
          
          echo "🧪 ユニットテスト開始: $test_dir"
          
          xvfb-run -a python -m pytest "$test_dir" \
            -v \
            --tb=short \
            --strict-markers \
            --strict-config \
            --cov=src \
            --cov-report=xml:test-outputs/coverage-unit-py${{ matrix.python-version }}.xml \
            --cov-report=html:test-outputs/htmlcov-unit-py${{ matrix.python-version }} \
            --cov-report=json:test-outputs/coverage-unit-py${{ matrix.python-version }}.json \
            --junitxml=test-outputs/unit-test-results-py${{ matrix.python-version }}.xml \
            --html=test-outputs/unit-test-report-py${{ matrix.python-version }}.html \
            --self-contained-html \
            --durations=10 \
            --maxfail=5 \
            --tb=line \
            -m "unit and not requires_auth and not requires_powershell" \
            || echo "::error::ユニットテストで失敗が発生しました"
        else
          echo "::warning::ユニットテストディレクトリが見つかりません"
          echo "UNIT_TESTS_SKIPPED=true" >> $GITHUB_ENV
        fi
        
        echo "::endgroup::"
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: :99
    
    - name: セキュリティスキャン実行
      run: |
        echo "::group::セキュリティ脆弱性スキャン"
        
        # Banditによるセキュリティスキャン
        bandit -r Scripts/ --format json -o bandit-security-report.json || true
        bandit -r Scripts/ --format txt || true
        
        # Safetyによる依存関係脆弱性スキャン  
        safety check --json --output safety-report.json || true
        safety check || true
        
        echo "::endgroup::"
    
    - name: セキュリティ品質ゲート
      run: |
        echo "::group::セキュリティ品質ゲート検証"
        
        # 高重要度セキュリティ問題の存在確認
        if [ -f "bandit-security-report.json" ]; then
          HIGH_ISSUES=$(python3 -c "
import json
try:
    with open('bandit-security-report.json', 'r') as f:
        data = json.load(f)
        high_issues = [r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']
        print(len(high_issues))
except:
    print('0')
")
          echo "高重要度セキュリティ問題数: $HIGH_ISSUES"
          
          if [ "$HIGH_ISSUES" -gt "0" ]; then
            echo "::error::高重要度のセキュリティ問題が検出されました。修正が必要です。"
            exit 1
          else
            echo "✅ 高重要度セキュリティ問題なし"
          fi
        fi
        
        echo "::endgroup::"
    
    - name: カバレッジ結果アップロード
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage-unit-py${{ matrix.python-version }}.xml
        flags: unittests
        name: unit-tests-python-${{ matrix.python-version }}
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
    
    - name: テスト結果アーティファクト保存
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results-python-${{ matrix.python-version }}
        path: |
          unit-test-results-py${{ matrix.python-version }}.xml
          unit-test-report-py${{ matrix.python-version }}.html
          htmlcov-unit-py${{ matrix.python-version }}/
          coverage-unit-py${{ matrix.python-version }}.xml
          coverage-unit-py${{ matrix.python-version }}.json
        retention-days: 30

  integration-tests:
    name: 統合テスト
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: unit-tests
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: Python 3.11 セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: システム依存関係インストール
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11-utils
    
    - name: Python依存関係インストール
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: 統合テスト実行
      run: |
        xvfb-run -a python -m pytest tests/integration \
          -v \
          --tb=short \
          --junitxml=integration-test-results.xml \
          --html=integration-test-report.html \
          --self-contained-html \
          --maxfail=5 \
          -m "integration and not requires_auth" || true
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: :99
    
    - name: 統合テスト結果アーティファクト保存
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          integration-test-results.xml
          integration-test-report.html
        retention-days: 30

  compatibility-tests:
    name: 互換性テスト（PowerShellなし）
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: Python 3.11 セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Python依存関係インストール
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: 互換性テスト実行（PowerShellスキップ）
      run: |
        python -m pytest tests/compatibility \
          -v \
          --tb=short \
          --junitxml=compatibility-test-results.xml \
          --html=compatibility-test-report.html \
          --self-contained-html \
          -m "compatibility and not requires_powershell and not requires_auth"
    
    - name: 互換性テスト結果アーティファクト保存
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: compatibility-test-results
        path: |
          compatibility-test-results.xml
          compatibility-test-report.html
        retention-days: 30

  gui-tests:
    name: GUIテスト
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: Python 3.11 セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: システム依存関係インストール
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          x11-utils \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          libegl1-mesa \
          libxkbcommon0 \
          libxkbcommon-x11-0 \
          libfontconfig1 \
          libfreetype6 \
          libx11-6 \
          libx11-xcb1 \
          libxext6 \
          libxfixes3 \
          libxi6 \
          libxrender1 \
          libxcb1 \
          libxcb-glx0 \
          libxcb-render0 \
          libgl1-mesa-glx \
          libglib2.0-0
    
    - name: Python依存関係インストール
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: GUIテスト実行
      run: |
        xvfb-run -a python -m pytest tests/ \
          -v \
          --tb=short \
          --junitxml=gui-test-results.xml \
          --html=gui-test-report.html \
          --self-contained-html \
          -m "gui and not requires_auth"
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: :99
        QT_LOGGING_RULES: '*.debug=false'
    
    - name: GUIテスト結果アーティファクト保存
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: gui-test-results
        path: |
          gui-test-results.xml
          gui-test-report.html
        retention-days: 30

  windows-compatibility:
    name: Windows互換性テスト
    runs-on: windows-latest
    needs: unit-tests
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: Python 3.11 セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: PowerShell Core インストール
      run: |
        winget install Microsoft.PowerShell
    
    - name: Python依存関係インストール
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: Windows ユニットテスト実行
      run: |
        python -m pytest tests/unit tests/compatibility \
          -v \
          --tb=short \
          --junitxml=windows-test-results.xml \
          --html=windows-test-report.html \
          --self-contained-html \
          -m "unit or compatibility and not requires_auth"
    
    - name: Windows テスト結果アーティファクト保存
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-test-results
        path: |
          windows-test-results.xml
          windows-test-report.html
        retention-days: 30

  security-scan:
    name: セキュリティスキャン
    runs-on: ubuntu-latest
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: Python 3.11 セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: セキュリティツールインストール
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
    
    - name: Bandit セキュリティスキャン
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -f txt
    
    - name: Safety 依存関係脆弱性スキャン
      run: |
        safety check --output json > safety-report.json || true
        safety check
    
    - name: セキュリティスキャン結果アーティファクト保存
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 90

  code-quality:
    name: コード品質チェック
    runs-on: ubuntu-latest
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: Python 3.11 セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: コード品質ツールインストール
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy
        pip install -r requirements.txt
    
    - name: Black フォーマットチェック
      run: |
        black --check --diff src/ Tests/ || echo "Black formatting check completed"
    
    - name: Flake8 リンティング
      run: |
        flake8 src/ Tests/ --max-line-length=100 --ignore=E501,W503 || echo "Flake8 linting completed"
    
    - name: MyPy 型チェック
      run: |
        mypy src/ --ignore-missing-imports || true

  comprehensive-report:
    name: 包括的レポート生成
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, compatibility-tests, gui-tests, security-scan, code-quality]
    if: always()
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: Python 3.11 セットアップ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: 全アーティファクトダウンロード
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Python依存関係インストール
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
    
    - name: 包括的レポート生成
      run: |
        python tests/run_test_suite.py --report-only || echo "Test suite completed with warnings"
    
    - name: 包括的レポートアーティファクト保存
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-ci-report
        path: |
          TestScripts/TestReports/comprehensive-test-report_*.html
          TestScripts/TestReports/comprehensive-test-summary_*.csv
          TestScripts/TestReports/comprehensive-test-data_*.json
        retention-days: 90

  deploy-docs:
    name: テストドキュメント公開
    runs-on: ubuntu-latest
    needs: comprehensive-report
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: リポジトリチェックアウト
      uses: actions/checkout@v4
    
    - name: 包括的レポートダウンロード
      uses: actions/download-artifact@v4
      with:
        name: comprehensive-ci-report
        path: docs/test-reports/
    
    - name: GitHub Pages デプロイ
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        destination_dir: test-reports