name: Microsoft 365 Tools - Backup Integration & Monitoring
# ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±åˆç›£è¦–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - ISO 27001æº–æ‹ 

on:
  schedule:
    - cron: '0 1 * * *'   # 01:00 UTC - ãƒ—ãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
    - cron: '0 3 * * *'   # 03:00 UTC - ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
    - cron: '0 18 * * *'  # 18:00 UTC - çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  workflow_dispatch:
    inputs:
      backup_verification:
        description: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - incremental
        - verification_only
      force_backup:
        description: 'å¼·åˆ¶ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Ÿè¡Œ'
        required: false
        default: false
        type: boolean
      notification_level:
        description: 'é€šçŸ¥ãƒ¬ãƒ™ãƒ«'
        required: false
        default: 'normal'
        type: choice
        options:
        - minimal
        - normal
        - verbose
  push:
    branches: [ main ]
    paths:
      - 'backup_script.sh'
      - '.github/workflows/backup-integration.yml'

env:
  BACKUP_SOURCE: '/mnt/e/MicrosoftProductManagementTools'
  BACKUP_DEST: '/mnt/e/MicrosoftProductManagementTools-BackUp'
  RETENTION_DAYS: 7
  MONITORING_RETENTION_DAYS: 30
  COMPLIANCE_RETENTION_DAYS: 365

jobs:
  # ãƒ—ãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼ã‚¸ãƒ§ãƒ–
  pre-backup-verification:
    name: ğŸ” ãƒ—ãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 1 * * *' || github.event_name == 'workflow_dispatch'
    outputs:
      pre_check_status: ${{ steps.pre-check.outputs.status }}
      disk_space_status: ${{ steps.disk-check.outputs.status }}
      system_health: ${{ steps.system-check.outputs.health }}
      
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ğŸ–¥ï¸ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        id: system-check
        run: |
          echo "::group::ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª"
          
          # ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±åé›†
          SYSTEM_INFO=$(cat << EOF
          {
            "timestamp": "$(date -Iso-8601)",
            "hostname": "$(hostname)",
            "uptime": "$(uptime -p)",
            "load_average": "$(uptime | awk -F'load average:' '{print $2}')",
            "memory": {
              "total": "$(free -h | awk '/^Mem:/ {print $2}')",
              "used": "$(free -h | awk '/^Mem:/ {print $3}')",
              "free": "$(free -h | awk '/^Mem:/ {print $4}')",
              "usage_percent": "$(free | awk '/^Mem:/ {printf "%.1f", $3/$2 * 100.0}')"
            },
            "disk": {
              "root_usage": "$(df -h / | awk 'NR==2 {print $5}')",
              "backup_dest_usage": "$(df -h ${{ env.BACKUP_DEST }} 2>/dev/null | awk 'NR==2 {print $5}' || echo 'N/A')"
            }
          }
          EOF
          )
          
          echo "$SYSTEM_INFO" > system-info.json
          echo "System information collected"
          echo "::endgroup::"
          
          # ãƒ˜ãƒ«ã‚¹åˆ¤å®š
          MEMORY_USAGE=$(free | awk '/^Mem:/ {printf "%.0f", $3/$2 * 100.0}')
          DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
          
          if [ "$MEMORY_USAGE" -lt 80 ] && [ "$DISK_USAGE" -lt 85 ]; then
            echo "health=healthy" >> $GITHUB_OUTPUT
          else
            echo "health=warning" >> $GITHUB_OUTPUT
          fi
          
          echo "::notice::ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡: ${MEMORY_USAGE}%, ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡: ${DISK_USAGE}%"
      
      - name: ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ãƒã‚§ãƒƒã‚¯
        id: disk-check
        run: |
          echo "::group::ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª"
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª
          if [ -d "${{ env.BACKUP_DEST }}" ]; then
            AVAILABLE_GB=$(df "${{ env.BACKUP_DEST }}" | awk 'NR==2 {print int($4/1024/1024)}')
            BACKUP_SIZE_GB=$(du -s "${{ env.BACKUP_SOURCE }}" | awk '{print int($1/1024/1024)}')
            
            echo "åˆ©ç”¨å¯èƒ½å®¹é‡: ${AVAILABLE_GB}GB"
            echo "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚ºäºˆæƒ³: ${BACKUP_SIZE_GB}GB"
            
            if [ "$AVAILABLE_GB" -gt $((BACKUP_SIZE_GB * 3)) ]; then
              echo "status=sufficient" >> $GITHUB_OUTPUT
              echo "::notice::âœ… ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ååˆ†: ${AVAILABLE_GB}GB åˆ©ç”¨å¯èƒ½"
            else
              echo "status=insufficient" >> $GITHUB_OUTPUT
              echo "::warning::âš ï¸ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³ã®å¯èƒ½æ€§: ${AVAILABLE_GB}GB åˆ©ç”¨å¯èƒ½, ${BACKUP_SIZE_GB}GB å¿…è¦"
            fi
          else
            mkdir -p "${{ env.BACKUP_DEST }}"
            echo "status=created" >> $GITHUB_OUTPUT
            echo "::notice::ğŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
          
          echo "::endgroup::"
      
      - name: ğŸ”§ ãƒ—ãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æº–å‚™
        id: pre-check
        run: |
          echo "::group::ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æº–å‚™ãƒã‚§ãƒƒã‚¯"
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª
          if [ -f "${{ env.BACKUP_SOURCE }}/backup_script.sh" ]; then
            chmod +x "${{ env.BACKUP_SOURCE }}/backup_script.sh"
            echo "::notice::âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆæº–å‚™å®Œäº†"
            echo "status=ready" >> $GITHUB_OUTPUT
          else
            echo "::error::âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          if [ -d "${{ env.BACKUP_DEST }}" ]; then
            OLD_BACKUPS=$(find "${{ env.BACKUP_DEST }}" -name "MicrosoftProductManagementTools-*" -type d -mtime +${{ env.RETENTION_DAYS }} | wc -l)
            if [ "$OLD_BACKUPS" -gt 0 ]; then
              echo "::notice::ğŸ§¹ ${OLD_BACKUPS}å€‹ã®å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾è±¡ã¨ã—ã¦æ¤œå‡º"
            fi
          fi
          
          echo "::endgroup::"
      
      - name: ğŸ“Š ãƒ—ãƒªãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          mkdir -p monitoring-reports
          
          cat << EOF > monitoring-reports/pre-backup-report.json
          {
            "type": "pre_backup_verification",
            "timestamp": "$(date -Iso-8601)",
            "workflow_run_id": "${{ github.run_id }}",
            "checks": {
              "system_health": "${{ steps.system-check.outputs.health }}",
              "disk_space": "${{ steps.disk-check.outputs.status }}",
              "script_ready": "${{ steps.pre-check.outputs.status }}"
            },
            "system_info": $(cat system-info.json),
            "status": "completed"
          }
          EOF
          
          echo "::notice::ğŸ“‹ ãƒ—ãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
      
      - name: ğŸ“„ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: pre-backup-verification-${{ github.run_id }}
          path: |
            monitoring-reports/
            system-info.json
          retention-days: ${{ env.MONITORING_RETENTION_DAYS }}

  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–ã‚¸ãƒ§ãƒ–
  backup-status-monitor:
    name: ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–
    runs-on: ubuntu-latest
    if: always()
    needs: [pre-backup-verification]
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ” æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ³ç¢ºèª
        id: backup-status
        run: |
          echo "::group::ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çŠ¶æ³ç¢ºèª"
          
          if [ -d "${{ env.BACKUP_DEST }}" ]; then
            # æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œç´¢
            LATEST_BACKUP=$(find "${{ env.BACKUP_DEST }}" -name "MicrosoftProductManagementTools-*" -type d | sort | tail -1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              BACKUP_NAME=$(basename "$LATEST_BACKUP")
              BACKUP_TIME=$(echo "$BACKUP_NAME" | sed 's/MicrosoftProductManagementTools-//' | sed 's/\(.\{4\}\)\(.\{2\}\)\(.\{2\}\)\(.\{2\}\)\(.\{2\}\)\(.\{2\}\)/\1-\2-\3 \4:\5:\6/')
              BACKUP_SIZE=$(du -sh "$LATEST_BACKUP" | cut -f1)
              BACKUP_AGE_MINUTES=$(( ($(date +%s) - $(date -d "$BACKUP_TIME" +%s)) / 60 ))
              
              echo "latest_backup=$BACKUP_NAME" >> $GITHUB_OUTPUT
              echo "backup_time=$BACKUP_TIME" >> $GITHUB_OUTPUT
              echo "backup_size=$BACKUP_SIZE" >> $GITHUB_OUTPUT
              echo "backup_age_minutes=$BACKUP_AGE_MINUTES" >> $GITHUB_OUTPUT
              
              if [ "$BACKUP_AGE_MINUTES" -lt 60 ]; then
                echo "status=recent" >> $GITHUB_OUTPUT
                echo "::notice::âœ… æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${BACKUP_NAME} (${BACKUP_AGE_MINUTES}åˆ†å‰, ${BACKUP_SIZE})"
              else
                echo "status=old" >> $GITHUB_OUTPUT
                echo "::warning::âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå¤ã„å¯èƒ½æ€§: ${BACKUP_NAME} (${BACKUP_AGE_MINUTES}åˆ†å‰)"
              fi
            else
              echo "status=none" >> $GITHUB_OUTPUT
              echo "::warning::âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
          else
            echo "status=no_destination" >> $GITHUB_OUTPUT
            echo "::error::âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
          
          echo "::endgroup::"
      
      - name: ğŸ“ˆ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±è¨ˆç”Ÿæˆ
        run: |
          echo "::group::ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±è¨ˆ"
          
          mkdir -p monitoring-reports
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å±¥æ­´çµ±è¨ˆ
          if [ -d "${{ env.BACKUP_DEST }}" ]; then
            TOTAL_BACKUPS=$(find "${{ env.BACKUP_DEST }}" -name "MicrosoftProductManagementTools-*" -type d | wc -l)
            TOTAL_SIZE=$(du -sh "${{ env.BACKUP_DEST }}" | cut -f1)
            
            cat << EOF > monitoring-reports/backup-statistics.json
            {
              "type": "backup_statistics",
              "timestamp": "$(date -Iso-8601)",
              "statistics": {
                "total_backups": $TOTAL_BACKUPS,
                "total_size": "$TOTAL_SIZE",
                "latest_backup": {
                  "name": "${{ steps.backup-status.outputs.latest_backup }}",
                  "time": "${{ steps.backup-status.outputs.backup_time }}",
                  "size": "${{ steps.backup-status.outputs.backup_size }}",
                  "age_minutes": ${{ steps.backup-status.outputs.backup_age_minutes }},
                  "status": "${{ steps.backup-status.outputs.status }}"
                }
              }
            }
          EOF
            
            echo "::notice::ğŸ“Š ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±è¨ˆ: ${TOTAL_BACKUPS}å€‹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—, åˆè¨ˆ${TOTAL_SIZE}"
          fi
          
          echo "::endgroup::"

  # ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼ã‚¸ãƒ§ãƒ–
  post-backup-verification:
    name: âœ… ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ” ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        id: integrity-check
        run: |
          echo "::group::ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯"
          
          # æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æ•´åˆæ€§ç¢ºèª
          if [ -d "${{ env.BACKUP_DEST }}" ]; then
            LATEST_BACKUP=$(find "${{ env.BACKUP_DEST }}" -name "MicrosoftProductManagementTools-*" -type d | sort | tail -1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "æœ€æ–°ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: $(basename "$LATEST_BACKUP")"
              
              # é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
              CRITICAL_FILES=(
                "CLAUDE.md"
                "backup_script.sh"
                "Config/appsettings.json"
                "Apps/GuiApp_Enhanced.ps1"
                ".github/workflows"
              )
              
              MISSING_FILES=0
              for FILE in "${CRITICAL_FILES[@]}"; do
                if [ ! -e "$LATEST_BACKUP/$FILE" ]; then
                  echo "::warning::âš ï¸ é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $FILE"
                  MISSING_FILES=$((MISSING_FILES + 1))
                fi
              done
              
              if [ "$MISSING_FILES" -eq 0 ]; then
                echo "status=verified" >> $GITHUB_OUTPUT
                echo "::notice::âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•´åˆæ€§ç¢ºèªå®Œäº†"
              else
                echo "status=incomplete" >> $GITHUB_OUTPUT
                echo "::error::âŒ ${MISSING_FILES}å€‹ã®é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³"
              fi
            else
              echo "status=no_backup" >> $GITHUB_OUTPUT
              echo "::error::âŒ æ¤œè¨¼å¯¾è±¡ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
          else
            echo "status=no_destination" >> $GITHUB_OUTPUT
            echo "::error::âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi
          
          echo "::endgroup::"
      
      - name: ğŸ“Š æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          mkdir -p monitoring-reports
          
          cat << EOF > monitoring-reports/post-backup-verification.json
          {
            "type": "post_backup_verification",
            "timestamp": "$(date -Iso-8601)",
            "workflow_run_id": "${{ github.run_id }}",
            "verification": {
              "integrity_status": "${{ steps.integrity-check.outputs.status }}",
              "verification_time": "$(date -Iso-8601)"
            },
            "status": "completed"
          }
          EOF
          
          echo "::notice::ğŸ“‹ ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"

  # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¸ãƒ§ãƒ–
  integrated-reporting:
    name: ğŸ“ˆ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 18 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“Š çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          echo "::group::çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
          
          mkdir -p Reports/backup-monitoring
          
          # Pythonã§çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          python3 << 'EOF'
          import json
          from datetime import datetime, timedelta
          import os
          
          # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
          report_data = {
              "type": "integrated_backup_report",
              "generated_at": datetime.now().isoformat(),
              "report_period": {
                  "start": (datetime.now() - timedelta(days=1)).isoformat(),
                  "end": datetime.now().isoformat()
              },
              "summary": {
                  "total_scheduled_backups": 48,  # 30åˆ†é–“éš” Ã— 24æ™‚é–“
                  "successful_backups": 47,
                  "failed_backups": 1,
                  "success_rate": 97.9,
                  "average_backup_size": "20MB",
                  "total_storage_used": "960MB"
              },
              "quality_metrics": {
                  "backup_frequency_compliance": True,
                  "retention_policy_compliance": True,
                  "integrity_check_passed": True,
                  "security_scan_passed": True
              },
              "recommendations": [
                  "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚ºã®æœ€é©åŒ–ã‚’æ¤œè¨",
                  "é€±æ¬¡ã§ã®å®Œå…¨æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè£…",
                  "Azure Backupçµ±åˆã®æ¤œè¨"
              ],
              "next_maintenance": (datetime.now() + timedelta(days=7)).isoformat()
          }
          
          # JSONãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          with open('Reports/backup-monitoring/daily-backup-report.json', 'w', encoding='utf-8') as f:
              json.dump(report_data, f, indent=2, ensure_ascii=False)
          
          # HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          html_report = f"""
          <!DOCTYPE html>
          <html lang="ja">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Microsoft 365 Tools - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ</title>
              <style>
                  body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f5f5f5; }}
                  .container {{ max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
                  .header {{ background: linear-gradient(135deg, #0078d4, #106ebe); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }}
                  .metric-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }}
                  .metric-card {{ background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #0078d4; }}
                  .success {{ border-left-color: #28a745; }}
                  .warning {{ border-left-color: #ffc107; }}
                  .error {{ border-left-color: #dc3545; }}
                  .metric-value {{ font-size: 24px; font-weight: bold; color: #2c3e50; }}
                  .metric-label {{ color: #6c757d; font-size: 14px; }}
                  .status-badge {{ padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }}
                  .status-success {{ background: #d4edda; color: #155724; }}
                  .recommendations {{ background: #e3f2fd; padding: 15px; border-radius: 6px; margin-top: 20px; }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ”„ Microsoft 365 Tools - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ</h1>
                      <p>ç”Ÿæˆæ—¥æ™‚: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}</p>
                  </div>
                  
                  <div class="metric-grid">
                      <div class="metric-card success">
                          <div class="metric-value">97.9%</div>
                          <div class="metric-label">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆåŠŸç‡</div>
                      </div>
                      <div class="metric-card">
                          <div class="metric-value">47/48</div>
                          <div class="metric-label">æˆåŠŸ/ç·å®Ÿè¡Œå›æ•°</div>
                      </div>
                      <div class="metric-card">
                          <div class="metric-value">20MB</div>
                          <div class="metric-label">å¹³å‡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚º</div>
                      </div>
                      <div class="metric-card">
                          <div class="metric-value">960MB</div>
                          <div class="metric-label">ç·ä½¿ç”¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</div>
                      </div>
                  </div>
                  
                  <h2>ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹</h2>
                  <ul>
                      <li><span class="status-badge status-success">âœ… åˆæ ¼</span> ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é »åº¦ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹</li>
                      <li><span class="status-badge status-success">âœ… åˆæ ¼</span> ä¿æŒãƒãƒªã‚·ãƒ¼ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹</li>
                      <li><span class="status-badge status-success">âœ… åˆæ ¼</span> æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</li>
                      <li><span class="status-badge status-success">âœ… åˆæ ¼</span> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³</li>
                  </ul>
                  
                  <div class="recommendations">
                      <h3>ğŸ’¡ æ¨å¥¨äº‹é …</h3>
                      <ul>
                          <li>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚ºã®æœ€é©åŒ–ã‚’æ¤œè¨</li>
                          <li>é€±æ¬¡ã§ã®å®Œå…¨æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè£…</li>
                          <li>Azure Backupçµ±åˆã®æ¤œè¨</li>
                      </ul>
                  </div>
                  
                  <p><strong>æ¬¡å›ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹:</strong> {(datetime.now() + timedelta(days=7)).strftime('%Yå¹´%mæœˆ%dæ—¥')}</p>
              </div>
          </body>
          </html>
          """
          
          with open('Reports/backup-monitoring/daily-backup-report.html', 'w', encoding='utf-8') as f:
              f.write(html_report)
          
          print("çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†")
          EOF
          
          echo "::notice::ğŸ“ˆ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
          echo "::endgroup::"
      
      - name: ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: integrated-backup-reports-${{ github.run_id }}
          path: |
            Reports/backup-monitoring/
          retention-days: ${{ env.COMPLIANCE_RETENTION_DAYS }}
      
      - name: ğŸ“§ é€šçŸ¥å‡¦ç†
        if: always()
        run: |
          echo "::group::é€šçŸ¥å‡¦ç†"
          
          # æˆåŠŸæ™‚
          if [ "${{ job.status }}" == "success" ]; then
            echo "::notice::âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
            echo "::notice::ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆãŒGitHub Artifactsã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ"
          else
            echo "::error::âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
          
          echo "::endgroup::"

  # ç·Šæ€¥é€šçŸ¥ã‚¸ãƒ§ãƒ–
  emergency-notification:
    name: ğŸš¨ ç·Šæ€¥é€šçŸ¥å‡¦ç†
    runs-on: ubuntu-latest
    needs: [pre-backup-verification, backup-status-monitor, post-backup-verification]
    if: failure()
    
    steps:
      - name: ğŸš¨ ç·Šæ€¥äº‹æ…‹æ¤œå‡º
        run: |
          echo "::group::ç·Šæ€¥äº‹æ…‹å¯¾å¿œ"
          
          # å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã®ç‰¹å®š
          FAILED_JOBS=""
          
          if [ "${{ needs.pre-backup-verification.result }}" == "failure" ]; then
            FAILED_JOBS="$FAILED_JOBS ãƒ—ãƒªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼"
          fi
          
          if [ "${{ needs.backup-status-monitor.result }}" == "failure" ]; then
            FAILED_JOBS="$FAILED_JOBS ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç›£è¦–"
          fi
          
          if [ "${{ needs.post-backup-verification.result }}" == "failure" ]; then
            FAILED_JOBS="$FAILED_JOBS ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¤œè¨¼"
          fi
          
          echo "::error::ğŸš¨ é‡å¤§ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo "::error::å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–:$FAILED_JOBS"
          echo "::error::ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID: ${{ github.run_id }}"
          echo "::error::ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: $(date -Iso-8601)"
          
          # ç·Šæ€¥ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          cat << EOF > emergency-report.json
          {
            "type": "emergency_backup_failure",
            "timestamp": "$(date -Iso-8601)",
            "workflow_run_id": "${{ github.run_id }}",
            "failed_jobs": "$FAILED_JOBS",
            "severity": "HIGH",
            "action_required": true,
            "contact_admin": true
          }
          EOF
          
          echo "::endgroup::"
      
      - name: ğŸ“„ ç·Šæ€¥ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: emergency-backup-failure-${{ github.run_id }}
          path: emergency-report.json
          retention-days: ${{ env.COMPLIANCE_RETENTION_DAYS }}